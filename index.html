<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized Processing Plant Organizational Chart</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: "Arial", sans-serif;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }
        
        .chart-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 30px;
            overflow: hidden;
        }
        
        /* HIERARCHY VIEW */
        .hierarchy-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.5s ease;
        }
        
        .hierarchy-view.hidden {
            opacity: 0;
            transform: translateX(-100%);
        }
        
        /* DRILL-DOWN VIEW */
        .drill-down-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease;
        }
        
        .drill-down-view.active {
            opacity: 1;
            transform: translateX(0%);
        }
        
        .drill-down-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(52,73,94,0.9));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1001;
        }
        
        .drill-down-title {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .back-button {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .drill-down-content {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px;
            overflow: auto;
        }
        
        /* EMPLOYEE CARDS */
        .employee-card {
            position: absolute;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            border: 2px solid #ddd;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
        }
        
        .employee-card:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            z-index: 100;
        }
        
        .plant-manager-card {
            border: 4px solid #ffd700;
            background: linear-gradient(145deg, #fff8dc, #ffeaa7);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }
        
        .director-card {
            border: 3px solid #3498db;
            background: linear-gradient(145deg, #e8f4fd, #d1ecf1);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .supervisor-card {
            border: 3px solid #f39c12;
            background: linear-gradient(145deg, #fef5e7, #fdeaa7);
            box-shadow: 0 5px 18px rgba(243, 156, 18, 0.3);
        }
        
        /* DEPARTMENT SUMMARY CARDS */
        .department-card {
            position: absolute;
            background: linear-gradient(145deg, #ffffff, #f1f2f6);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            border: 3px solid;
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .department-card:hover {
            transform: scale(1.08) translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
            z-index: 100;
        }
        
        .dept-production { border-color: #e74c3c; background: linear-gradient(145deg, #fdf2f2, #fce8e8); }
        .dept-kitchen { border-color: #f39c12; background: linear-gradient(145deg, #fef9f2, #fcf3e8); }
        .dept-processing-lab { border-color: #3498db; background: linear-gradient(145deg, #f2f8fd, #e8f4fd); }
        .dept-warehouse { border-color: #2ecc71; background: linear-gradient(145deg, #f2fcf7, #e8f8f0); }
        .dept-quality { border-color: #9b59b6; background: linear-gradient(145deg, #f7f2fc, #f0e8f8); }
        .dept-maintenance { border-color: #34495e; background: linear-gradient(145deg, #f5f6f7, #eaecee); }
        .dept-analytical-lab { border-color: #1abc9c; background: linear-gradient(145deg, #f2fcfa, #e8f8f5); }
        
        .dept-title {
            font-weight: bold;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.1;
            margin-bottom: 6px;
        }
        
        .dept-count {
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* DRILL-DOWN EMPLOYEE CARDS */
        .drill-employee-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
            border: 2px solid #ddd;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin: 3px;
        }
        
        .drill-employee-card:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 18px rgba(0,0,0,0.3);
        }
        
        .card-photo {
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid white;
            display: block;
            background: linear-gradient(135deg, #bdc3c7, #ecf0f1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        /* IMPROVED: Universal text styling for better name visibility */
        .card-name {
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            line-height: 1.15;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            font-size: 11px !important;
            min-height: 30px;
            max-width: 100%;
        }
        
        .card-position {
            text-align: center;
            color: #7f8c8d;
            font-weight: 600;
            word-wrap: break-word;
            font-size: 10px !important;
            line-height: 1.1;
        }
        
        .card-shift {
            text-align: center;
            background: rgba(52, 73, 94, 0.15);
            color: #2c3e50;
            border-radius: 3px;
            font-weight: 500;
            padding: 1px 3px;
            font-size: 9px !important;
            line-height: 1.1;
        }
        
        .supervisor-dept-indicator {
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 4px;
            padding: 2px 6px;
            margin: 2px 0;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            font-size: 9px !important;
            line-height: 1.1;
        }
        
        .dept-indicator {
            text-align: center;
            color: #95a5a6;
            text-transform: uppercase;
            font-size: 9px !important;
            line-height: 1.1;
        }
        
        /* Drill-down card text styling */
        .drill-card-name {
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            line-height: 1.15;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            font-size: 10px !important;
            max-width: 100%;
        }
        
        .drill-card-position {
            text-align: center;
            color: #7f8c8d;
            font-weight: 600;
            font-size: 9px !important;
            line-height: 1.1;
        }
        
        .drill-card-shift {
            text-align: center;
            background: rgba(52, 73, 94, 0.15);
            color: #2c3e50;
            border-radius: 3px;
            font-weight: 500;
            padding: 1px 3px;
            font-size: 8px !important;
            line-height: 1.1;
        }
        
        .connection-line {
            position: absolute;
            background: linear-gradient(180deg, rgba(52, 73, 94, 0.7), rgba(52, 73, 94, 0.3));
            z-index: 1;
            border-radius: 1px;
        }
        
        .tv-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.95);
            color: #ffaa00;
            text-align: center;
            padding: 4px;
            font-size: 10px;
            z-index: 1000;
        }
        
        .dept-production .dept-count { color: #e74c3c; }
        .dept-kitchen .dept-count { color: #f39c12; }
        .dept-processing-lab .dept-count { color: #3498db; }
        .dept-warehouse .dept-count { color: #2ecc71; }
        .dept-quality .dept-count { color: #9b59b6; }
        .dept-maintenance .dept-count { color: #34495e; }
        .dept-analytical-lab .dept-count { color: #1abc9c; }
    </style>
</head>
<body>
    <div class="chart-container">
        <!-- HIERARCHY VIEW -->
        <div class="hierarchy-view" id="hierarchyView">
            <div id="orgChart"></div>
        </div>
        
        <!-- DRILL-DOWN VIEW -->
        <div class="drill-down-view" id="drillDownView">
            <div class="drill-down-header">
                <div class="drill-down-title" id="drillDownTitle">Department View</div>
                <button class="back-button" id="backButton">‚Üê Back to Hierarchy</button>
            </div>
            <div class="drill-down-content" id="drillDownContent"></div>
        </div>
    </div>
    
    <div class="tv-controls">
        üì∫ Optimized Layout: Clear Director ‚Üí Supervisor ‚Üí Department Lines | Click Department ‚Üí View Employees | ESC=Back | 1-7=Quick Access
    </div>
    
    <script>
        // Employee data - Complete organizational structure
        const employees = [
            // Plant Manager
            { "id": 1, "name": "Dora Garza", "position": "Plant Manager", "department": "Management", "parentId": null, "shift": "", "dept_color": "#95a5a6" },
            
            // Directors
            { "id": 2, "name": "Luis Hernandez", "position": "Director", "department": "Kitchen", "parentId": 1, "shift": "", "dept_color": "#f39c12" },
            { "id": 3, "name": "Lester Igarza", "position": "Director", "department": "Production", "parentId": 1, "shift": "", "dept_color": "#e74c3c" },
            { "id": 4, "name": "Sunita Jainanan", "position": "Director", "department": "Processing Lab", "parentId": 1, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 5, "name": "Carlos Archaga", "position": "Director", "department": "Processing Lab", "parentId": 1, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 6, "name": "Michael Amaya", "position": "Director", "department": "Warehouse", "parentId": 1, "shift": "", "dept_color": "#2ecc71" },
            { "id": 7, "name": "Mariela De La Rosa", "position": "Director", "department": "Quality", "parentId": 1, "shift": "", "dept_color": "#9b59b6" },
            { "id": 8, "name": "Abel Ortega", "position": "Director", "department": "Maintenance", "parentId": 1, "shift": "", "dept_color": "#34495e" },
            { "id": 10, "name": "Natalie Zeledon", "position": "Supervisor", "department": "Analytical Lab", "parentId": 1, "shift": "", "dept_color": "#1abc9c" },
            
            // Kitchen Supervisors
            { "id": 11, "name": "Idalmis Medina Rodriguez", "position": "Supervisor", "department": "Kitchen", "parentId": 2, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 12, "name": "Nathan Vargas", "position": "Supervisor", "department": "Kitchen", "parentId": 2, "shift": "2nd Shift", "dept_color": "#f39c12" },
            
            // Production Supervisors
            { "id": 13, "name": "Jubilee Rodriguez", "position": "Supervisor", "department": "Production", "parentId": 3, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 14, "name": "Maria Mendez", "position": "Supervisor", "department": "Production", "parentId": 3, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 15, "name": "Samantha Perez-Morell", "position": "Supervisor", "department": "Production", "parentId": 3, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            
            // Warehouse Supervisors
            { "id": 16, "name": "Susana Ceballos", "position": "Supervisor", "department": "Warehouse", "parentId": 6, "shift": "", "dept_color": "#2ecc71" },
            { "id": 17, "name": "Norma Rodriguez", "position": "Supervisor", "department": "Warehouse", "parentId": 6, "shift": "", "dept_color": "#2ecc71" },
            
            // Quality Supervisor
            { "id": 18, "name": "Gabriela Urbina", "position": "Supervisor", "department": "Quality", "parentId": 7, "shift": "", "dept_color": "#9b59b6" },
            
            // FIXED: Dan Peluso is now a Maintenance Supervisor under Abel Ortega
            { "id": 9, "name": "Dan Peluso", "position": "Supervisor", "department": "Maintenance", "parentId": 8, "shift": "", "dept_color": "#34495e" },
            
            // Kitchen Employees - 1st Shift
            { "id": 19, "name": "Fabiola Trujillo", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 20, "name": "Yurisan Marin", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 21, "name": "Niurka Cazada", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 22, "name": "Ramon Garcia", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 23, "name": "Willie Lozano", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 24, "name": "Isabel Alvarado", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 25, "name": "Ivan Delavega", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 26, "name": "Karla Archaga", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            
            // Kitchen Employees - 2nd Shift
            { "id": 27, "name": "Larry Collins", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 28, "name": "Jake Roth", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 29, "name": "Alex Ventura", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 30, "name": "Mildrey Guerra", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 31, "name": "Lydia Mendez", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 32, "name": "Francisco Beltran Rodriguez", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 33, "name": "Alberto Beltran Rivero", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 34, "name": "Elizabeth Ambroso", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 35, "name": "Alba Botero", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 36, "name": "Jason Levine", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            
            // Production Employees - 1st Shift (50 employees)
            { "id": 37, "name": "Ana Fernandez Fernandez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 38, "name": "Laidamys Blanco", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 39, "name": "Yanet Pesquiera", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 40, "name": "Maria De Silva", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 41, "name": "Belkis Carballo", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 42, "name": "Alejandro Godoy", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 43, "name": "Angel Ortiz Rodriguez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 44, "name": "Adolfo Valdes", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 45, "name": "Rafael Campana", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 46, "name": "Alberto Curiel", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 47, "name": "Charity Parks", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 48, "name": "Sailys Rodriguez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 49, "name": "Maria Vega", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 50, "name": "Carolina Sanchez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 51, "name": "Lourdes Sanchez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 52, "name": "Haydee Perez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 53, "name": "Martha Betancur", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 54, "name": "Gloriberth", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 55, "name": "Jorge Orjuela Lozano", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 56, "name": "Maite Corria", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 57, "name": "Maximino Plaza", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 58, "name": "Mavilin Marrero", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 59, "name": "Yabelkis Banos", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 60, "name": "Maray Valdes Lozano", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 61, "name": "Maricel Castellanos", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 62, "name": "Rosalva Contreras", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 63, "name": "Carlos Hernandez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 64, "name": "Sofia Rodriguez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 65, "name": "Miguel Santos", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 66, "name": "Elena Vargas", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 67, "name": "Fernando Lopez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 68, "name": "Isabella Cruz", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 69, "name": "Ricardo Morales", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 70, "name": "Valentina Ruiz", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 71, "name": "Alejandro Diaz", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 72, "name": "Camila Fernandez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 73, "name": "Diego Torres", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 74, "name": "Lucia Martinez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 75, "name": "Gabriel Ramirez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 76, "name": "Andrea Gonzalez", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 77, "name": "Sebastian Jimenez", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 78, "name": "Natalia Castro", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 79, "name": "Mateo Ortiz", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 80, "name": "Paula Herrera", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 81, "name": "Nicolas Ramos", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 82, "name": "Daniela Flores", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 83, "name": "Juan Carlos Medina", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 84, "name": "Mariana Delgado", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 85, "name": "Santiago Rivera", "position": "Employee", "department": "Production", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 86, "name": "Catalina Vega", "position": "Employee", "department": "Production", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            
            // Production Employees - 2nd Shift (30 employees)
            { "id": 87, "name": "Abelardo Rodriguez", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 88, "name": "Alberto Loyola-Mesa", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 89, "name": "Zithlaly Mendez", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 90, "name": "Josefina Acosta", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 91, "name": "Ana Zambrano", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 92, "name": "Galatea Gutierrez", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 93, "name": "Mario Hernandez", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 94, "name": "Jorge Acosta", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 95, "name": "Maria Amador", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 96, "name": "Karel Acosta", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 97, "name": "Ruth Garcia", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 98, "name": "Yanet Rodriguez", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 99, "name": "Sandra Bayona", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 100, "name": "Dora Molina", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 101, "name": "Blanca Bedoya", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 102, "name": "Roberto Silva", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 103, "name": "Carmen Aguilar", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 104, "name": "Eduardo Paredes", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 105, "name": "Guadalupe Navarro", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 106, "name": "Sergio Mendoza", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 107, "name": "Esperanza Guerrero", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 108, "name": "Arturo Campos", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 109, "name": "Rosa Elena Soto", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 110, "name": "Raul Contreras", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 111, "name": "Patricia Varela", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 112, "name": "Victor Hugo Paz", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 113, "name": "Silvia Moreno", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 114, "name": "Andres Castillo", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 115, "name": "Leticia Sandoval", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 116, "name": "Omar Figueroa", "position": "Employee", "department": "Production", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            
            // Processing Lab Employees
            { "id": 117, "name": "Michael Slager", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 118, "name": "Carolina Ceballos", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 119, "name": "Luis Acevedo", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 120, "name": "Maria Paz", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 121, "name": "Joshua Lastres", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 122, "name": "Armando Hernandez", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 123, "name": "Melissa Loyola", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 124, "name": "Randy Castellano", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 125, "name": "Karla De La Cruz", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 126, "name": "Diego", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            
            // Warehouse Employees
            { "id": 127, "name": "Reginald Knight", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 128, "name": "Jorge Figueroa", "position": "Employee", "department": "Warehouse", "parentId": 17, "shift": "", "dept_color": "#2ecc71" },
            { "id": 129, "name": "Renier Robaina", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 130, "name": "Ivan Camejo", "position": "Employee", "department": "Warehouse", "parentId": 17, "shift": "", "dept_color": "#2ecc71" },
            { "id": 131, "name": "Steven Wisby", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 132, "name": "Gary Rodriguez", "position": "Employee", "department": "Warehouse", "parentId": 17, "shift": "", "dept_color": "#2ecc71" },
            { "id": 133, "name": "Natalie Martinez", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            
            // Quality Employees
            { "id": 134, "name": "Irina Naumenco", "position": "Employee", "department": "Quality", "parentId": 18, "shift": "", "dept_color": "#9b59b6" },
            { "id": 135, "name": "Maria Dominguez", "position": "Employee", "department": "Quality", "parentId": 18, "shift": "", "dept_color": "#9b59b6" },
            
            // Maintenance Employees
            { "id": 136, "name": "Jose Miranda", "position": "Employee", "department": "Maintenance", "parentId": 9, "shift": "", "dept_color": "#34495e" },
            { "id": 137, "name": "Jose Acosta", "position": "Employee", "department": "Maintenance", "parentId": 9, "shift": "", "dept_color": "#34495e" },
            { "id": 138, "name": "Yusdriviel Rodriguez", "position": "Employee", "department": "Maintenance", "parentId": 9, "shift": "", "dept_color": "#34495e" },
            
            // Analytical Lab Employee
            { "id": 139, "name": "Miguel Colina", "position": "Employee", "department": "Analytical Lab", "parentId": 10, "shift": "", "dept_color": "#1abc9c" }
        ];
        
        let screenWidth = 1280;
        let screenHeight = 690;
        let isDrillDownActive = false;
        let currentDepartment = null;
        
        const departmentNames = ["Production", "Kitchen", "Processing Lab", "Warehouse", "Quality", "Maintenance", "Analytical Lab"];
        
        function calculateScreenDimensions() {
            const container = document.querySelector(".chart-container");
            if (container) {
                screenWidth = container.clientWidth || 1280;
                screenHeight = container.clientHeight || 690;
            }
        }
        
        function calculateOptimalSizing() {
            calculateScreenDimensions();
            
            const padding = 20;
            const availableWidth = screenWidth - (padding * 2);
            const availableHeight = screenHeight - (padding * 2);
            
            // Count elements that need to fit horizontally
            const directors = employees.filter(emp => emp.position === "Director");
            const departmentCount = departmentNames.length;
            
            // Calculate optimal widths for each row
            const directorRowWidth = availableWidth / directors.length;
            const departmentRowWidth = availableWidth / departmentCount;
            
            // Find the constraining width
            const constrainingWidth = Math.min(directorRowWidth, departmentRowWidth) * 0.85;
            
            // Calculate heights based on vertical space
            const availableVerticalSpace = availableHeight * 0.85;
            const plantManagerHeight = availableVerticalSpace * 0.20;
            const directorHeight = availableVerticalSpace * 0.22;
            const supervisorHeight = availableVerticalSpace * 0.18;
            const departmentHeight = availableVerticalSpace * 0.15;
            
            // IMPROVED: Slightly larger card dimensions for better font accommodation
            const cardDimensions = {
                "Plant Manager": {
                    width: Math.min(constrainingWidth * 1.4, 340),
                    height: Math.min(plantManagerHeight, 240)
                },
                "Director": {
                    width: Math.min(constrainingWidth, 260),
                    height: Math.min(directorHeight, 200)
                },
                "Supervisor": {
                    width: Math.min(constrainingWidth * 0.8, 220),
                    height: Math.min(supervisorHeight, 160)
                },
                "Department": {
                    width: Math.min(constrainingWidth, 240),
                    height: Math.min(departmentHeight, 130)
                }
            };
            
            // IMPROVED: Increased minimum sizes for better text readability
            Object.keys(cardDimensions).forEach(key => {
                if (key === "Director") {
                    cardDimensions[key].width = Math.max(cardDimensions[key].width, 180);
                    cardDimensions[key].height = Math.max(cardDimensions[key].height, 130);
                } else if (key === "Plant Manager") {
                    cardDimensions[key].width = Math.max(cardDimensions[key].width, 160);
                    cardDimensions[key].height = Math.max(cardDimensions[key].height, 120);
                } else if (key === "Supervisor") {
                    cardDimensions[key].width = Math.max(cardDimensions[key].width, 140);
                    cardDimensions[key].height = Math.max(cardDimensions[key].height, 100);
                } else {
                    cardDimensions[key].width = Math.max(cardDimensions[key].width, 140);
                    cardDimensions[key].height = Math.max(cardDimensions[key].height, 100);
                }
            });
            
            return cardDimensions;
        }
        
        function calculateHierarchyLayout() {
            const padding = 20;
            const cardDimensions = calculateOptimalSizing();
            
            // Position Plant Manager
            const dora = employees.find(emp => emp.name === "Dora Garza");
            if (dora) {
                dora.x_pos = (screenWidth - cardDimensions["Plant Manager"].width) / 2;
                dora.y_pos = padding;
            }
            
            // Position Directors
            const directors = employees.filter(emp => emp.position === "Director");
            const directorY = padding + cardDimensions["Plant Manager"].height + 30;
            const directorSpacing = Math.max(15, (screenWidth - padding * 2 - directors.length * cardDimensions.Director.width) / (directors.length + 1));
            
            directors.forEach((director, index) => {
                director.x_pos = padding + directorSpacing + index * (cardDimensions.Director.width + directorSpacing);
                director.y_pos = directorY;
            });
            
            // Position Supervisors
            const supervisors = employees.filter(emp => emp.position === "Supervisor");
            const supervisorY = directorY + cardDimensions.Director.height + 25;
            
            supervisors.forEach(supervisor => {
                const parentDirector = employees.find(emp => emp.id === supervisor.parentId);
                if (parentDirector) {
                    const siblingsSupervisors = supervisors.filter(s => s.parentId === supervisor.parentId);
                    const siblingIndex = siblingsSupervisors.indexOf(supervisor);
                    const totalSiblings = siblingsSupervisors.length;
                    
                    if (totalSiblings === 1) {
                        supervisor.x_pos = parentDirector.x_pos + (cardDimensions.Director.width - cardDimensions.Supervisor.width) / 2;
                    } else {
                        const spacing = Math.max(5, (cardDimensions.Director.width - totalSiblings * cardDimensions.Supervisor.width) / (totalSiblings + 1));
                        supervisor.x_pos = parentDirector.x_pos + spacing + siblingIndex * (cardDimensions.Supervisor.width + spacing);
                    }
                    supervisor.y_pos = supervisorY;
                }
            });
            
            // OPTIMIZED: Position department cards directly under their supervisors
            const deptY = supervisorY + cardDimensions.Supervisor.height + 30;
            
            window.departmentSummaries = [];
            
            departmentNames.forEach((deptName) => {
                const deptEmployees = employees.filter(emp => emp.department === deptName && emp.position === "Employee");
                const deptSupervisors = employees.filter(emp => emp.department === deptName && emp.position === "Supervisor");
                
                if (deptEmployees.length > 0 && deptSupervisors.length > 0) {
                    // Calculate average X position of supervisors for this department
                    const avgSupervisorX = deptSupervisors.reduce((sum, sup) => sum + sup.x_pos + cardDimensions.Supervisor.width / 2, 0) / deptSupervisors.length;
                    
                    const deptSummary = {
                        name: deptName,
                        employee_count: deptEmployees.length,
                        x_pos: avgSupervisorX - cardDimensions.Department.width / 2, // Center under supervisors
                        y_pos: deptY,
                        width: cardDimensions.Department.width,
                        height: cardDimensions.Department.height,
                        supervisors: deptSupervisors.map(s => s.name),
                        color: deptEmployees[0].dept_color
                    };
                    
                    // Ensure department card doesn't go off screen
                    deptSummary.x_pos = Math.max(padding, Math.min(deptSummary.x_pos, screenWidth - padding - cardDimensions.Department.width));
                    
                    window.departmentSummaries.push(deptSummary);
                }
            });
            
            // Store card dimensions globally
            window.currentCardDimensions = cardDimensions;
        }
        
        function createEmployeeCard(employee, cardDimensions) {
            const card = document.createElement("div");
            
            let dimensions;
            if (employee.position === "Plant Manager") {
                dimensions = cardDimensions["Plant Manager"];
            } else if (employee.position === "Director") {
                dimensions = cardDimensions["Director"];
            } else if (employee.position === "Supervisor") {
                dimensions = cardDimensions["Supervisor"];
            }
            
            card.className = `employee-card ${employee.position.toLowerCase().replace(' ', '-')}-card`;
            card.style.left = employee.x_pos + "px";
            card.style.top = employee.y_pos + "px";
            card.style.width = dimensions.width + "px";
            card.style.height = dimensions.height + "px";
            
            // IMPROVED: Fixed font sizing with universal approach
            const photoSize = Math.min(dimensions.width * 0.25, dimensions.height * 0.25);
            const isCompact = dimensions.height < 100;
            const photoMargin = isCompact ? 2 : 4;
            const textMargin = isCompact ? 1 : 2;
            
            const shiftHtml = employee.shift ? `<div class="card-shift" style="margin: ${textMargin}px 0;">${employee.shift}</div>` : "";
            
            // FIXED: Supervisors only show the colored badge, no position text
            let positionHtml = "";
            let deptIndicatorHtml = "";
            
            if (employee.position === "Supervisor") {
                // Only show the colored supervisor badge
                deptIndicatorHtml = `<div class="supervisor-dept-indicator" style="background-color: ${employee.dept_color}; margin: ${textMargin}px 0;">SUPERVISOR</div>`;
            } else {
                // Show position text for non-supervisors
                positionHtml = `<div class="card-position" style="margin: ${textMargin}px 0;">${employee.position}</div>`;
                deptIndicatorHtml = `<div class="dept-indicator" style="margin: ${textMargin}px 0;">${employee.department}</div>`;
            }
            
            card.innerHTML = `
                <img class="card-photo" 
                     src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='${photoSize}' height='${photoSize}' viewBox='0 0 ${photoSize} ${photoSize}'><rect width='${photoSize}' height='${photoSize}' fill='%23ecf0f1' rx='4' ry='4'/><circle cx='${photoSize/2}' cy='${photoSize*0.35}' r='${photoSize*0.12}' fill='%23bdc3c7'/><ellipse cx='${photoSize/2}' cy='${photoSize*0.78}' rx='${photoSize*0.18}' ry='${photoSize*0.12}' fill='%23bdc3c7'/></svg>" 
                     alt="${employee.name}"
                     style="width: ${photoSize}px; height: ${photoSize}px; margin: ${photoMargin}px 0;">
                <div class="card-name" style="margin: ${textMargin}px 2px;">${employee.name}</div>
                ${positionHtml}
                ${deptIndicatorHtml}
                ${shiftHtml}
            `;
            
            return card;
        }
        
        function createDepartmentCard(deptData, cardDimensions) {
            const card = document.createElement("div");
            const dimensions = cardDimensions["Department"];
            
            card.className = `department-card dept-${deptData.name.toLowerCase().replace(/\s+/g, "-")}`;
            card.style.left = deptData.x_pos + "px";
            card.style.top = deptData.y_pos + "px";
            card.style.width = dimensions.width + "px";
            card.style.height = dimensions.height + "px";
            
            // Dynamic text sizing
            const titleSize = Math.max(11, Math.min(16, dimensions.width / 12));
            const countSize = Math.max(10, Math.min(14, dimensions.width / 14));
            
            const isCompact = dimensions.height < 90;
            const titleMargin = isCompact ? 2 : 4;
            
            card.innerHTML = `
                <div class="dept-title" style="font-size: ${titleSize}px; margin-bottom: ${titleMargin}px;">${deptData.name}</div>
                <div class="dept-count" style="font-size: ${countSize}px;">(${deptData.employee_count}) employees</div>
            `;
            
            card.addEventListener("click", () => openDrillDown(deptData.name));
            
            return card;
        }
        
        function generateConnectionLines(cardDimensions) {
            const chartContainer = document.getElementById("orgChart");
            if (!chartContainer) return;
            
            // IMPROVED: Clear hierarchy connection lines (Plant Manager ‚Üí Directors ‚Üí Supervisors)
            employees.forEach(emp => {
                if (emp.parentId && (emp.position === "Director" || emp.position === "Supervisor")) {
                    const parent = employees.find(e => e.id === emp.parentId);
                    if (parent) {
                        const line = createConnectionLine(parent, emp, cardDimensions);
                        chartContainer.appendChild(line);
                    }
                }
            });
            
            // Optimized supervisor-to-department lines
            const supervisors = employees.filter(emp => emp.position === "Supervisor");
            supervisors.forEach(supervisor => {
                if (window.departmentSummaries) {
                    const deptCard = window.departmentSummaries.find(dept => dept.name === supervisor.department);
                    if (deptCard) {
                        const lines = createOptimizedSupervisorToDeptLines(supervisor, deptCard, cardDimensions);
                        lines.forEach(line => chartContainer.appendChild(line));
                    }
                }
            });
        }
        
        function createConnectionLine(parent, child, cardDimensions) {
            const line = document.createElement("div");
            line.className = "connection-line";
            
            let parentDimensions, childDimensions;
            if (parent.position === "Plant Manager") {
                parentDimensions = cardDimensions["Plant Manager"];
            } else if (parent.position === "Director") {
                parentDimensions = cardDimensions["Director"];
            }
            
            if (child.position === "Director") {
                childDimensions = cardDimensions["Director"];
            } else if (child.position === "Supervisor") {
                childDimensions = cardDimensions["Supervisor"];
            }
            
            const parentX = parent.x_pos + parentDimensions.width / 2;
            const parentY = parent.y_pos + parentDimensions.height;
            const childX = child.x_pos + childDimensions.width / 2;
            const childY = child.y_pos;
            
            const lineHeight = childY - parentY;
            const lineWidth = Math.max(2, Math.min(4, Math.round(screenWidth / 400)));
            
            // Enhanced line styling for better visibility
            if (child.position === "Supervisor") {
                line.style.background = `linear-gradient(180deg, rgba(52, 152, 219, 0.8), ${child.dept_color}CC)`;
            } else {
                line.style.background = `linear-gradient(180deg, rgba(52, 73, 94, 0.7), rgba(52, 73, 94, 0.3))`;
            }
            
            if (lineHeight > 0) {
                line.style.left = (parentX - lineWidth/2) + "px";
                line.style.top = parentY + "px";
                line.style.width = lineWidth + "px";
                line.style.height = lineHeight + "px";
            }
            
            return line;
        }
        
        function createOptimizedSupervisorToDeptLines(supervisor, deptCard, cardDimensions) {
            const lines = [];
            const supervisorDimensions = cardDimensions["Supervisor"];
            
            const supervisorX = supervisor.x_pos + supervisorDimensions.width / 2;
            const supervisorY = supervisor.y_pos + supervisorDimensions.height;
            const deptX = deptCard.x_pos + deptCard.width / 2;
            const deptY = deptCard.y_pos;
            
            const lineWidth = Math.max(2, Math.min(3, Math.round(screenWidth / 500)));
            
            // OPTIMIZED: Check if they're well-aligned vertically (within 40px)
            if (Math.abs(supervisorX - deptX) <= 40) {
                // Simple vertical line - they're optimally aligned
                const verticalLine = document.createElement("div");
                verticalLine.className = "connection-line";
                verticalLine.style.background = `linear-gradient(180deg, ${supervisor.dept_color}CC, ${supervisor.dept_color}80)`;
                verticalLine.style.left = (supervisorX - lineWidth/2) + "px";
                verticalLine.style.top = supervisorY + "px";
                verticalLine.style.width = lineWidth + "px";
                verticalLine.style.height = (deptY - supervisorY) + "px";
                lines.push(verticalLine);
            } else {
                // Clean L-shaped connection for cases where perfect alignment isn't possible
                const midY = supervisorY + (deptY - supervisorY) * 0.6;
                
                // Vertical line from supervisor
                const verticalLine1 = document.createElement("div");
                verticalLine1.className = "connection-line";
                verticalLine1.style.background = `linear-gradient(180deg, ${supervisor.dept_color}CC, ${supervisor.dept_color}80)`;
                verticalLine1.style.left = (supervisorX - lineWidth/2) + "px";
                verticalLine1.style.top = supervisorY + "px";
                verticalLine1.style.width = lineWidth + "px";
                verticalLine1.style.height = (midY - supervisorY) + "px";
                lines.push(verticalLine1);
                
                // Horizontal line
                const horizontalLine = document.createElement("div");
                horizontalLine.className = "connection-line";
                horizontalLine.style.background = `linear-gradient(90deg, ${supervisor.dept_color}80, ${supervisor.dept_color}80)`;
                const horizontalStart = Math.min(supervisorX, deptX);
                const horizontalEnd = Math.max(supervisorX, deptX);
                horizontalLine.style.left = (horizontalStart - lineWidth/2) + "px";
                horizontalLine.style.top = (midY - lineWidth/2) + "px";
                horizontalLine.style.width = (horizontalEnd - horizontalStart + lineWidth) + "px";
                horizontalLine.style.height = lineWidth + "px";
                lines.push(horizontalLine);
                
                // Vertical line to department
                const verticalLine2 = document.createElement("div");
                verticalLine2.className = "connection-line";
                verticalLine2.style.background = `linear-gradient(180deg, ${supervisor.dept_color}80, ${supervisor.dept_color}CC)`;
                verticalLine2.style.left = (deptX - lineWidth/2) + "px";
                verticalLine2.style.top = midY + "px";
                verticalLine2.style.width = lineWidth + "px";
                verticalLine2.style.height = (deptY - midY) + "px";
                lines.push(verticalLine2);
            }
            
            return lines;
        }
        
        function initHierarchyView() {
            calculateHierarchyLayout();
            
            const chartContainer = document.getElementById("orgChart");
            chartContainer.innerHTML = "";
            
            const cardDimensions = window.currentCardDimensions;
            
            // Add connection lines
            generateConnectionLines(cardDimensions);
            
            // Add hierarchy employees
            employees.forEach(emp => {
                if (emp.position === "Plant Manager" || emp.position === "Director" || emp.position === "Supervisor") {
                    const card = createEmployeeCard(emp, cardDimensions);
                    chartContainer.appendChild(card);
                }
            });
            
            // Add department cards
            if (window.departmentSummaries) {
                window.departmentSummaries.forEach(deptData => {
                    const card = createDepartmentCard(deptData, cardDimensions);
                    chartContainer.appendChild(card);
                });
            }
        }
        
        function openDrillDown(departmentName) {
            currentDepartment = departmentName;
            isDrillDownActive = true;
            
            const hierarchyView = document.getElementById("hierarchyView");
            const drillDownView = document.getElementById("drillDownView");
            const drillDownTitle = document.getElementById("drillDownTitle");
            const drillDownContent = document.getElementById("drillDownContent");
            
            hierarchyView.classList.add("hidden");
            drillDownView.classList.add("active");
            
            const deptEmployees = employees.filter(emp => emp.department === departmentName && emp.position === "Employee");
            drillDownTitle.textContent = `${departmentName} Department (${deptEmployees.length} Employees)`;
            
            layoutDrillDownEmployees(deptEmployees, drillDownContent);
        }
        
        function layoutDrillDownEmployees(deptEmployees, container) {
            container.innerHTML = "";
            
            const availableWidth = screenWidth - 40;
            const availableHeight = screenHeight - 100;
            const numEmployees = deptEmployees.length;
            
            // Calculate optimal grid
            let bestCols = 1;
            let bestCardSize = 0;
            
            for (let cols = 1; cols <= Math.min(25, numEmployees); cols++) {
                const rows = Math.ceil(numEmployees / cols);
                const cardWidth = Math.floor((availableWidth - (cols - 1) * 8) / cols);
                const cardHeight = Math.floor((availableHeight - (rows - 1) * 10) / rows);
                const cardSize = Math.min(cardWidth, cardHeight);
                
                if (cardSize > bestCardSize && cardSize >= 60) {
                    bestCardSize = cardSize;
                    bestCols = cols;
                }
            }
            
            bestCardSize = Math.min(bestCardSize, 200);
            
            // Create employee cards
            deptEmployees.forEach((employee, index) => {
                const row = Math.floor(index / bestCols);
                const col = index % bestCols;
                
                const card = document.createElement("div");
                card.className = "drill-employee-card";
                card.style.width = bestCardSize + "px";
                card.style.height = bestCardSize + "px";
                card.style.left = (col * (bestCardSize + 8) + 20) + "px";
                card.style.top = (row * (bestCardSize + 10) + 20) + "px";
                card.style.position = "absolute";
                
                const photoSize = Math.min(bestCardSize * 0.35, 80);
                const isCompact = bestCardSize < 100;
                const margin = isCompact ? 1 : 2;
                
                const shiftHtml = employee.shift ? `<div class="drill-card-shift" style="margin: ${margin}px 0;">${employee.shift}</div>` : "";
                
                card.innerHTML = `
                    <img class="card-photo" 
                         src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='${photoSize}' height='${photoSize}' viewBox='0 0 ${photoSize} ${photoSize}'><rect width='${photoSize}' height='${photoSize}' fill='%23ecf0f1' rx='3' ry='3'/><circle cx='${photoSize/2}' cy='${photoSize*0.35}' r='${photoSize*0.11}' fill='%23bdc3c7'/><ellipse cx='${photoSize/2}' cy='${photoSize*0.75}' rx='${photoSize*0.16}' ry='${photoSize*0.10}' fill='%23bdc3c7'/></svg>" 
                         alt="${employee.name}"
                         style="width: ${photoSize}px; height: ${photoSize}px; margin: ${margin}px 0;">
                    <div class="drill-card-name" style="margin: ${margin}px 2px;">${employee.name}</div>
                    <div class="drill-card-position" style="margin: ${margin}px 0;">${employee.position}</div>
                    ${shiftHtml}
                `;
                
                container.appendChild(card);
            });
        }
        
        // FIXED: Proper back button functionality
        function closeDrillDown() {
            const hierarchyView = document.getElementById("hierarchyView");
            const drillDownView = document.getElementById("drillDownView");
            
            if (hierarchyView && drillDownView) {
                hierarchyView.classList.remove("hidden");
                drillDownView.classList.remove("active");
            }
            
            isDrillDownActive = false;
            currentDepartment = null;
        }
        
        // Navigation controls
        document.addEventListener("keydown", function(e) {
            switch(e.key) {
                case "Escape":
                    e.preventDefault();
                    if (isDrillDownActive) {
                        closeDrillDown();
                    }
                    break;
                    
                case "1": if (!isDrillDownActive) openDrillDown("Production"); break;
                case "2": if (!isDrillDownActive) openDrillDown("Kitchen"); break;
                case "3": if (!isDrillDownActive) openDrillDown("Processing Lab"); break;
                case "4": if (!isDrillDownActive) openDrillDown("Warehouse"); break;
                case "5": if (!isDrillDownActive) openDrillDown("Quality"); break;
                case "6": if (!isDrillDownActive) openDrillDown("Maintenance"); break;
                case "7": if (!isDrillDownActive) openDrillDown("Analytical Lab"); break;
            }
        });
        
        window.addEventListener("resize", function() {
            setTimeout(() => {
                if (!isDrillDownActive) {
                    initHierarchyView();
                }
            }, 200);
        });
        
        // FIXED: Initialize with proper back button event listener
        document.addEventListener("DOMContentLoaded", function() {
            // Set up back button event listener
            const backButton = document.getElementById("backButton");
            if (backButton) {
                backButton.addEventListener("click", closeDrillDown);
            }
            
            initHierarchyView();
        });
    </script>
</body>
</html>