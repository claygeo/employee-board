<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing Plant Organizational Chart - Compact Horizontal Cards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: 
                linear-gradient(135deg, rgba(30, 60, 114, 0.85) 0%, rgba(42, 82, 152, 0.85) 100%),
                url('./pictures/summer.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            font-family: "Arial", sans-serif;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }
        
        .chart-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        /* HIERARCHY VIEW */
        .hierarchy-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: all 0.5s ease;
        }
        
        .hierarchy-view.hidden {
            opacity: 0;
            transform: translateX(-100%);
        }
        
        /* DRILL-DOWN VIEW */
        .drill-down-view {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(135deg, rgba(44, 62, 80, 0.95) 0%, rgba(52, 73, 94, 0.95) 100%),
                url('./pictures/summer.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease;
        }
        
        .drill-down-view.active {
            opacity: 1;
            transform: translateX(0%);
        }
        
        .drill-down-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(52,73,94,0.9));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1001;
        }
        
        .drill-down-title {
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .back-button {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .drill-down-content {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px;
            overflow: auto;
        }
        
        /* IMPROVED TALLER HORIZONTAL EMPLOYEE CARDS */
        .employee-card {
            position: absolute;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border: 2px solid;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            padding: 8px; /* Increased from 6px */
        }
        
        .employee-card:hover {
            transform: scale(1.05) translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.35);
            z-index: 100;
        }
        
        /* DEPARTMENT-BASED STYLING */
        .dept-extraction-card {
            border-color: #e67e22;
            background: linear-gradient(145deg, #fdf6f0, #fcf3ec);
            box-shadow: 0 4px 12px rgba(230, 126, 34, 0.3);
        }
        
        .dept-processing-lab-card {
            border-color: #3498db;
            background: linear-gradient(145deg, #f2f8fd, #e8f4fd);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .dept-kitchen-card {
            border-color: #f39c12;
            background: linear-gradient(145deg, #fef9f2, #fcf3e8);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }
        
        .dept-packaging-card {
            border-color: #e74c3c;
            background: linear-gradient(145deg, #fdf2f2, #fce8e8);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .dept-warehouse-card {
            border-color: #2ecc71;
            background: linear-gradient(145deg, #f2fcf7, #e8f8f0);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .dept-maintenance-card {
            border-color: #34495e;
            background: linear-gradient(145deg, #f5f6f7, #eaecee);
            box-shadow: 0 4px 12px rgba(52, 73, 94, 0.3);
        }
        
        .dept-quality-card {
            border-color: #9b59b6;
            background: linear-gradient(145deg, #f7f2fc, #f0e8f8);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }
        
        .dept-management-card {
            border-color: #ffd700;
            background: linear-gradient(145deg, #fff8dc, #ffeaa7);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        
        /* POSITION-BASED BORDER THICKNESS */
        .manager-operations-card { border-width: 4px; }
        .director-supply-chain-card { border-width: 4px; }
        .manager-maintenance-card { border-width: 4px; }
        .director-card { border-width: 3px; }
        .manager-card { border-width: 3px; }
        .supervisor-card { border-width: 3px; }
        .quality-specialist-card { border-width: 3px; }
        .lead-card { border-width: 3px; }
        
        /* PHOTO SECTION - Left side */
        .card-photo-section {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px; /* Increased from 8px */
        }
        
        /* TEXT SECTION - Right side, improved spacing */
        .card-text-section {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 3px; /* Increased from 1px */
            line-height: 1.2; /* Improved from 1.1 */
            overflow: hidden;
            min-width: 0;
        }
        
        .card-photo {
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid white;
            display: block;
            background: linear-gradient(135deg, #bdc3c7, #ecf0f1);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        
        /* IMPROVED TEXT - Better readability */
        .card-name {
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            word-wrap: break-word;
            font-size: 12px; /* Increased from 11px */
            margin: 0;
            padding: 0;
            white-space: normal;
        }
        
        .card-title {
            color: #566573;
            font-weight: 500;
            font-size: 10px;
            line-height: 1.1;
            margin: 0;
            padding: 0;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-position {
            color: #7f8c8d;
            font-weight: 500;
            font-size: 10px; /* Increased from 9px */
            line-height: 1.1;
            margin: 0;
            padding: 0;
            white-space: normal; /* Changed from nowrap to allow wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* DEPARTMENT SUMMARY CARDS */
        .department-card {
            position: absolute;
            background: linear-gradient(145deg, #ffffff, #f1f2f6);
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
            border: 3px solid;
            cursor: pointer;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .department-card:hover {
            transform: scale(1.08) translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            z-index: 100;
        }
        
        .dept-packaging { border-color: #e74c3c; background: linear-gradient(145deg, #fdf2f2, #fce8e8); }
        .dept-kitchen { border-color: #f39c12; background: linear-gradient(145deg, #fef9f2, #fcf3e8); }
        .dept-processing-lab { border-color: #3498db; background: linear-gradient(145deg, #f2f8fd, #e8f4fd); }
        .dept-warehouse { border-color: #2ecc71; background: linear-gradient(145deg, #f2fcf7, #e8f8f0); }
        .dept-quality { border-color: #9b59b6; background: linear-gradient(145deg, #f7f2fc, #f0e8f8); }
        .dept-maintenance { border-color: #34495e; background: linear-gradient(145deg, #f5f6f7, #eaecee); }
        .dept-extraction { border-color: #e67e22; background: linear-gradient(145deg, #fdf6f0, #fcf3ec); }
        
        .dept-title {
            font-weight: bold;
            color: #2c3e50;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            margin-bottom: 4px;
            line-height: 1.1;
        }
        
        .dept-count {
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .dept-packaging .dept-count { color: #e74c3c; }
        .dept-kitchen .dept-count { color: #f39c12; }
        .dept-processing-lab .dept-count { color: #3498db; }
        .dept-warehouse .dept-count { color: #2ecc71; }
        .dept-quality .dept-count { color: #9b59b6; }
        .dept-maintenance .dept-count { color: #34495e; }
        .dept-extraction .dept-count { color: #e67e22; }
        
        /* DRILL-DOWN EMPLOYEE CARDS */
        .drill-employee-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(248,249,250,0.95));
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid #ddd;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 4px;
            margin: 2px;
        }
        
        .drill-employee-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .drill-card-photo-section {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
        }
        
        .drill-card-text-section {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1px;
            line-height: 1.1;
            min-width: 0;
        }
        
        .drill-card-name {
            font-weight: bold;
            color: #2c3e50;
            line-height: 1.1;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
            font-size: 9px;
            word-wrap: break-word;
        }
        
        .drill-card-title {
            color: #566573;
            font-weight: 500;
            font-size: 8px;
            line-height: 1.0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .drill-card-position {
            color: #7f8c8d;
            font-weight: 500;
            font-size: 8px;
            line-height: 1.0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* CONNECTION LINES */
        .connection-line {
            position: absolute;
            background: linear-gradient(180deg, rgba(52, 73, 94, 0.8), rgba(52, 73, 94, 0.4));
            z-index: 1;
            border-radius: 1px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .hierarchy-line-plant-manager {
            position: absolute;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.9), rgba(52, 152, 219, 0.7));
            z-index: 2;
            border-radius: 2px;
            box-shadow: 0 2px 6px rgba(255, 215, 0, 0.4);
        }
        
        .hierarchy-line-director {
            position: absolute;
            background: linear-gradient(180deg, rgba(52, 152, 219, 0.9), rgba(243, 156, 18, 0.7));
            z-index: 2;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }
        
        .hierarchy-line-maintenance {
            position: absolute;
            background: linear-gradient(180deg, rgba(52, 73, 94, 0.9), rgba(149, 165, 166, 0.7));
            z-index: 2;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(52, 73, 94, 0.3);
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <!-- HIERARCHY VIEW -->
        <div class="hierarchy-view" id="hierarchyView">
            <div id="orgChart"></div>
        </div>
        
        <!-- DRILL-DOWN VIEW -->
        <div class="drill-down-view" id="drillDownView">
            <div class="drill-down-header">
                <div class="drill-down-title" id="drillDownTitle">Department View</div>
                <button class="back-button" id="backButton">← Back to Hierarchy</button>
            </div>
            <div class="drill-down-content" id="drillDownContent"></div>
        </div>
    </div>
    
    <script>
        // UPDATED Employee data with THREE CO-EQUAL LEADERS: Dora, Michael, Abel
        const employees = [
            // THREE CO-EQUAL TOP-LEVEL LEADERS (parentId: null)
            { "id": 1, "name": "Dora Gaeza", "position": "Manager, Operations", "department": "Management", "parentId": null, "shift": "", "dept_color": "#95a5a6" },
            { "id": 6, "name": "Michael Amaya", "position": "Director, Supply Chain", "department": "Warehouse", "parentId": null, "shift": "", "dept_color": "#2ecc71" },
            { "id": 8, "name": "Abel Ortega", "position": "Manager, Maintenance", "department": "Maintenance", "parentId": null, "shift": "", "dept_color": "#34495e" },
            
            // Managers under Dora (5 total) - UPDATED TITLES
            { "id": 2, "name": "Luis Hernandez", "position": "Manager, Kitchen", "department": "Kitchen", "parentId": 1, "shift": "", "dept_color": "#f39c12" },
            { "id": 140, "name": "Daniel Gelpi", "position": "Manager, Extraction", "department": "Extraction", "parentId": 1, "shift": "", "dept_color": "#e67e22" },
            { "id": 3, "name": "Lester Igarza", "position": "Manager, Production", "department": "Packaging", "parentId": 1, "shift": "", "dept_color": "#e74c3c" },
            
            // Managers under Michael (1 total) - UPDATED TITLES
            { "id": 16, "name": "Susana Ceballos", "position": "Manager, Inventory", "department": "Warehouse", "parentId": 6, "shift": "", "dept_color": "#2ecc71" },
            
            // Supervisors under Dora (2 total) - UPDATED TITLES
            { "id": 4, "name": "Sunita Jainanan", "position": "Supervisor, Processing", "department": "Processing Lab", "parentId": 1, "shift": "", "dept_color": "#3498db" },
            { "id": 5, "name": "Carlos Archaga", "position": "Supervisor, Processing", "department": "Processing Lab", "parentId": 1, "shift": "", "dept_color": "#3498db" },
            
            // Supervisors under their respective managers
            { "id": 17, "name": "Norma Rodriguez", "position": "Supervisor, Logistics", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 9, "name": "Dan Peluso", "position": "Supervisor, Maintenance", "department": "Maintenance", "parentId": 8, "shift": "", "dept_color": "#34495e" },
            
            // Quality Specialist
            { "id": 7, "name": "Mariela De La Rosa", "position": "Quality Specialist", "department": "Quality", "parentId": 140, "shift": "", "dept_color": "#9b59b6" },
            
            // Department Leads - UPDATED TITLES
            { "id": 11, "name": "Idalmis Medina Rodriguez", "position": "Lead, Kitchen", "department": "Kitchen", "parentId": 2, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 12, "name": "Nathan Vargas", "position": "Lead, Kitchen", "department": "Kitchen", "parentId": 2, "shift": "2nd Shift", "dept_color": "#f39c12" },
            
            // Packaging Supervisors - UPDATED TITLES
            { "id": 13, "name": "Jubilee Rodriguez", "position": "Supervisor, Production", "department": "Packaging", "parentId": 3, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 14, "name": "Maria Mendez", "position": "Supervisor, Production", "department": "Packaging", "parentId": 3, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 15, "name": "Samantha Perez-Morell", "position": "Supervisor, Production", "department": "Packaging", "parentId": 3, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            
            // Quality Employees
            { "id": 134, "name": "Irina Naumenco", "position": "Employee", "department": "Quality", "parentId": 7, "shift": "", "dept_color": "#9b59b6" },
            { "id": 135, "name": "Maria Dominguez", "position": "Employee", "department": "Quality", "parentId": 7, "shift": "", "dept_color": "#9b59b6" },
            { "id": 18, "name": "Gabriela Urbina", "position": "Associate", "department": "Quality", "parentId": 7, "shift": "", "dept_color": "#9b59b6" },
            
            // Extraction Employees
            { "id": 141, "name": "Raimart Castellanos", "position": "Employee", "department": "Extraction", "parentId": 140, "shift": "1st Shift", "dept_color": "#e67e22" },
            { "id": 142, "name": "Mikael Gonzalez", "position": "Employee", "department": "Extraction", "parentId": 140, "shift": "1st Shift", "dept_color": "#e67e22" },
            { "id": 143, "name": "Anthony Perrera", "position": "Employee", "department": "Extraction", "parentId": 140, "shift": "1st Shift", "dept_color": "#e67e22" },
            { "id": 144, "name": "Jack Scilla", "position": "Employee", "department": "Extraction", "parentId": 140, "shift": "1st Shift", "dept_color": "#e67e22" },
            { "id": 145, "name": "Camilo Torres", "position": "Employee", "department": "Extraction", "parentId": 140, "shift": "2nd Shift", "dept_color": "#e67e22" },
            { "id": 146, "name": "Jenneth Miranda", "position": "Employee", "department": "Extraction", "parentId": 140, "shift": "2nd Shift", "dept_color": "#e67e22" },
            
            // Kitchen Employees - 1st Shift
            { "id": 19, "name": "Fabiola Trujillo", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 20, "name": "Yurisan Marin", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 21, "name": "Niurka Cazada", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 22, "name": "Ramon Garcia", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 23, "name": "Willie Lozano", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 24, "name": "Isabel Alvarado", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 25, "name": "Ivan Delavega", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            { "id": 26, "name": "Karla Archaga", "position": "Employee", "department": "Kitchen", "parentId": 11, "shift": "1st Shift", "dept_color": "#f39c12" },
            
            // Kitchen Employees - 2nd Shift
            { "id": 27, "name": "Larry Collins", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 28, "name": "Jake Roth", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 29, "name": "Alex Ventura", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 30, "name": "Mildrey Guerra", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 31, "name": "Lydia Mendez", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 32, "name": "Francisco Beltran Rodriguez", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 33, "name": "Alberto Beltran Rivero", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 34, "name": "Elizabeth Ambroso", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 35, "name": "Alba Botero", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            { "id": 36, "name": "Jason Levine", "position": "Employee", "department": "Kitchen", "parentId": 12, "shift": "2nd Shift", "dept_color": "#f39c12" },
            
            // Packaging Employees - 1st Shift (50 employees)
            { "id": 37, "name": "Ana Fernandez Fernandez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 38, "name": "Laidamys Blanco", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 39, "name": "Yanet Pesquiera", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 40, "name": "Maria De Silva", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 41, "name": "Belkis Carballo", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 42, "name": "Alejandro Godoy", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 43, "name": "Angel Ortiz Rodriguez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 44, "name": "Adolfo Valdes", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 45, "name": "Rafael Campana", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 46, "name": "Alberto Curiel", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 47, "name": "Charity Parks", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 48, "name": "Sailys Rodriguez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 49, "name": "Maria Vega", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 50, "name": "Carolina Sanchez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 51, "name": "Lourdes Sanchez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 52, "name": "Haydee Perez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 53, "name": "Martha Betancur", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 54, "name": "Gloriberth", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 55, "name": "Jorge Orjuela Lozano", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 56, "name": "Maite Corria", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 57, "name": "Maximino Plaza", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 58, "name": "Mavilin Marrero", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 59, "name": "Yabelkis Banos", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 60, "name": "Maray Valdes Lozano", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 61, "name": "Maricel Castellanos", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 62, "name": "Rosalva Contreras", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 63, "name": "Carlos Hernandez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 64, "name": "Sofia Rodriguez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 65, "name": "Miguel Santos", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 66, "name": "Elena Vargas", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 67, "name": "Fernando Lopez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 68, "name": "Isabella Cruz", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 69, "name": "Ricardo Morales", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 70, "name": "Valentina Ruiz", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 71, "name": "Alejandro Diaz", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 72, "name": "Camila Fernandez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 73, "name": "Diego Torres", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 74, "name": "Lucia Martinez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 75, "name": "Gabriel Ramirez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 76, "name": "Andrea Gonzalez", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 77, "name": "Sebastian Jimenez", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 78, "name": "Natalia Castro", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 79, "name": "Mateo Ortiz", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 80, "name": "Paula Herrera", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 81, "name": "Nicolas Ramos", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 82, "name": "Daniela Flores", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 83, "name": "Juan Carlos Medina", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 84, "name": "Mariana Delgado", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 85, "name": "Santiago Rivera", "position": "Employee", "department": "Packaging", "parentId": 13, "shift": "1st Shift", "dept_color": "#e74c3c" },
            { "id": 86, "name": "Catalina Vega", "position": "Employee", "department": "Packaging", "parentId": 14, "shift": "1st Shift", "dept_color": "#e74c3c" },
            
            // Packaging Employees - 2nd Shift (30 employees)
            { "id": 87, "name": "Abelardo Rodriguez", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 88, "name": "Alberto Loyola-Mesa", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 89, "name": "Zithlaly Mendez", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 90, "name": "Josefina Acosta", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 91, "name": "Ana Zambrano", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 92, "name": "Galatea Gutierrez", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 93, "name": "Mario Hernandez", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 94, "name": "Jorge Acosta", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 95, "name": "Maria Amador", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 96, "name": "Karel Acosta", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 97, "name": "Ruth Garcia", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 98, "name": "Yanet Rodriguez", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 99, "name": "Sandra Bayona", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 100, "name": "Dora Molina", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 101, "name": "Blanca Bedoya", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 102, "name": "Roberto Silva", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 103, "name": "Carmen Aguilar", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 104, "name": "Eduardo Paredes", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 105, "name": "Guadalupe Navarro", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 106, "name": "Sergio Mendoza", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 107, "name": "Esperanza Guerrero", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 108, "name": "Arturo Campos", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 109, "name": "Rosa Elena Soto", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 110, "name": "Raul Contreras", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 111, "name": "Patricia Varela", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 112, "name": "Victor Hugo Paz", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 113, "name": "Silvia Moreno", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 114, "name": "Andres Castillo", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 115, "name": "Leticia Sandoval", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            { "id": 116, "name": "Omar Figueroa", "position": "Employee", "department": "Packaging", "parentId": 15, "shift": "2nd Shift", "dept_color": "#e74c3c" },
            
            // Processing Lab Employees
            { "id": 117, "name": "Michael Slager", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 118, "name": "Carolina Ceballos", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 119, "name": "Luis Acevedo", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 120, "name": "Maria Paz", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 1", "dept_color": "#3498db" },
            { "id": 121, "name": "Joshua Lastres", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 2", "dept_color": "#3498db", "photo": "./pictures/joshua_lastres.jpg" },
            { "id": 122, "name": "Armando Hernandez", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 123, "name": "Melissa Loyola", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 2", "dept_color": "#3498db" },
            { "id": 124, "name": "Randy Castellano", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 3", "dept_color": "#3498db" },
            { "id": 125, "name": "Karla De La Cruz", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Shift 3", "dept_color": "#3498db" },
            { "id": 126, "name": "Diego", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Shift 3", "dept_color": "#3498db" },
            { "id": 139, "name": "Miguel Colina", "position": "Employee", "department": "Processing Lab", "parentId": 4, "shift": "Former Analytical Lab", "dept_color": "#3498db" },
            { "id": 10, "name": "Natalie Zeledon", "position": "Employee", "department": "Processing Lab", "parentId": 5, "shift": "Former Analytical Lab", "dept_color": "#3498db" },
            
            // Warehouse Employees
            { "id": 127, "name": "Reginald Knight", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 128, "name": "Jorge Figueroa", "position": "Employee", "department": "Warehouse", "parentId": 17, "shift": "", "dept_color": "#2ecc71" },
            { "id": 129, "name": "Renier Robaina", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 130, "name": "Ivan Camejo", "position": "Employee", "department": "Warehouse", "parentId": 17, "shift": "", "dept_color": "#2ecc71" },
            { "id": 131, "name": "Steven Wisby", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            { "id": 132, "name": "Gary Rodriguez", "position": "Employee", "department": "Warehouse", "parentId": 17, "shift": "", "dept_color": "#2ecc71" },
            { "id": 133, "name": "Natalie Martinez", "position": "Employee", "department": "Warehouse", "parentId": 16, "shift": "", "dept_color": "#2ecc71" },
            
            // Maintenance Employees
            { "id": 136, "name": "Jose Miranda", "position": "Employee", "department": "Maintenance", "parentId": 9, "shift": "", "dept_color": "#34495e" },
            { "id": 137, "name": "Jose Acosta", "position": "Employee", "department": "Maintenance", "parentId": 9, "shift": "", "dept_color": "#34495e" },
            { "id": 138, "name": "Yusdriviel Rodriguez", "position": "Employee", "department": "Maintenance", "parentId": 9, "shift": "", "dept_color": "#34495e" }
        ];
        
        let screenWidth = 1280;
        let screenHeight = 690;
        let isDrillDownActive = false;
        let currentDepartment = null;
        
        // Updated department names order: Extraction → Processing → Kitchen → Packaging → Warehouse → Maintenance
        const departmentNames = ["Extraction", "Processing Lab", "Kitchen", "Packaging", "Warehouse", "Maintenance", "Quality"];
        let createdConnections = new Set();
        
        // SMART name wrapping for compact cards
        function wrapLongName(name) {
            const parts = name.split(' ');
            
            // For names with 3+ parts, break after first name
            if (parts.length >= 3 && name.length > 18) {
                return parts[0] + '<br>' + parts.slice(1).join(' ');
            }
            
            // For 2-part names that are long
            if (parts.length === 2 && name.length > 20) {
                return parts[0] + '<br>' + parts[1];
            }
            
            return name;
        }

        // NEW: Smart position wrapping for long titles
        function wrapLongPosition(position) {
            // If position contains a comma, wrap at the comma
            if (position.includes(', ')) {
                return position.replace(', ', ',<br>');
            }
            
            return position;
        }

        // Calculate compact text dimensions
        function measureTextDimensions(text, fontSize) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = `${fontSize}px Arial`;
            const metrics = context.measureText(text);
            return {
                width: metrics.width,
                height: fontSize * 1.2 // Approximate height
            };
        }
        
        function calculateScreenDimensions() {
            const container = document.querySelector(".chart-container");
            if (container) {
                screenWidth = container.clientWidth || 1280;
                screenHeight = container.clientHeight || 690;
            }
        }
        
        function calculateOptimalSizing() {
            calculateScreenDimensions();
            
            const padding = 10;
            const isSmallScreen = screenWidth < 1400;
            
            // IMPROVED CARD DIMENSIONS - INCREASED HEIGHT BY ~5% FOR BETTER TEXT VISIBILITY
            const photoSize = isSmallScreen ? 45 : 55;
            const baseTextWidth = isSmallScreen ? 85 : 105; // Slightly wider for better text
            const heightIncrease = 23; // Increased from 18 to 23 for even better text visibility (5% increase)
            
            const cardDimensions = {
                "Manager, Operations": {
                    photoSize: photoSize + 10,
                    textWidth: baseTextWidth + 25,
                    height: photoSize + 20 + heightIncrease
                },
                "Director, Supply Chain": {
                    photoSize: photoSize + 10,
                    textWidth: baseTextWidth + 25,
                    height: photoSize + 20 + heightIncrease
                },
                "Manager, Maintenance": {
                    photoSize: photoSize + 10,
                    textWidth: baseTextWidth + 25,
                    height: photoSize + 20 + heightIncrease
                },
                "Manager, Kitchen": {
                    photoSize: photoSize,
                    textWidth: baseTextWidth + 15,
                    height: photoSize + 12 + heightIncrease
                },
                "Manager, Extraction": {
                    photoSize: photoSize,
                    textWidth: baseTextWidth + 15,
                    height: photoSize + 12 + heightIncrease
                },
                "Manager, Production": {
                    photoSize: photoSize,
                    textWidth: baseTextWidth + 15,
                    height: photoSize + 12 + heightIncrease
                },
                "Manager, Inventory": {
                    photoSize: photoSize,
                    textWidth: baseTextWidth + 15,
                    height: photoSize + 12 + heightIncrease
                },
                "Supervisor, Processing": {
                    photoSize: photoSize - 2,
                    textWidth: baseTextWidth + 10,
                    height: photoSize + 10 + heightIncrease
                },
                "Supervisor, Production": {
                    photoSize: photoSize - 2,
                    textWidth: baseTextWidth + 10,
                    height: photoSize + 10 + heightIncrease
                },
                "Supervisor, Logistics": {
                    photoSize: photoSize - 2,
                    textWidth: baseTextWidth + 10,
                    height: photoSize + 10 + heightIncrease
                },
                "Supervisor, Maintenance": {
                    photoSize: photoSize - 2,
                    textWidth: baseTextWidth + 10,
                    height: photoSize + 10 + heightIncrease
                },
                "Lead, Kitchen": {
                    photoSize: photoSize - 5,
                    textWidth: baseTextWidth + 5,
                    height: photoSize + 8 + heightIncrease
                },
                "Quality Specialist": {
                    photoSize: photoSize,
                    textWidth: baseTextWidth + 15,
                    height: photoSize + 12 + heightIncrease
                },
                "Department": {
                    width: Math.min(120, screenWidth * 0.09),
                    height: Math.min(100, screenHeight * 0.095)
                }
            };
            
            return cardDimensions;
        }
        
        // IMPROVED PROCESS FLOW POSITIONING WITH BETTER SPACING AND THREE TOP-LEVEL LEADERS
        function calculateProcessFlowLayout() {
            const padding = 15;
            const cardDimensions = calculateOptimalSizing();
            const isSmallScreen = screenWidth < 1400;
            
            // Position THREE CO-EQUAL TOP-LEVEL LEADERS
            const dora = employees.find(emp => emp.name === "Dora Gaeza");
            const michael = employees.find(emp => emp.name === "Michael Amaya");
            const abel = employees.find(emp => emp.name === "Abel Ortega");
            
            if (dora) {
                const doraDims = cardDimensions["Manager, Operations"];
                const doraWidth = doraDims.photoSize + doraDims.textWidth + 20;
                dora.x_pos = (screenWidth - doraWidth) / 2;
                dora.y_pos = padding;
                dora.cardWidth = doraWidth;
                dora.cardHeight = doraDims.height;
            }
            
            // RESPONSIVE PROCESS FLOW ZONES - SHIFTED EXTRACTION LEFT BY 5%
            const availableWidth = screenWidth - (padding * 2);
            const numZones = 6; // extraction, processing, kitchen, packaging, warehouse, maintenance
            const zoneWidth = availableWidth / numZones;
            const extractionShift = screenWidth * 0.05; // 5% left shift for extraction zone
            
            const processZones = {
                extraction: { 
                    x_start: padding - extractionShift, // MOVED LEFT BY 5%
                    width: zoneWidth 
                },
                processing: { 
                    x_start: padding + zoneWidth - extractionShift * 0.5, // Slight adjustment
                    width: zoneWidth 
                },
                kitchen: { 
                    x_start: padding + (zoneWidth * 2), 
                    width: zoneWidth 
                },
                packaging: { 
                    x_start: padding + (zoneWidth * 3), 
                    width: zoneWidth 
                },
                warehouse: { 
                    x_start: padding + (zoneWidth * 4), 
                    width: zoneWidth 
                },
                maintenance: { 
                    x_start: padding + (zoneWidth * 5), 
                    width: zoneWidth 
                }
            };
            
            // Position Michael in warehouse zone, Abel in maintenance zone
            if (michael) {
                const michaelDims = cardDimensions["Director, Supply Chain"];
                const michaelWidth = michaelDims.photoSize + michaelDims.textWidth + 20;
                michael.x_pos = processZones.warehouse.x_start + (processZones.warehouse.width - michaelWidth) / 2;
                michael.y_pos = padding;
                michael.cardWidth = michaelWidth;
                michael.cardHeight = michaelDims.height;
                michael.x_pos = Math.max(padding, Math.min(michael.x_pos, screenWidth - padding - michaelWidth));
            }
            
            if (abel) {
                const abelDims = cardDimensions["Manager, Maintenance"];
                const abelWidth = abelDims.photoSize + abelDims.textWidth + 20;
                abel.x_pos = processZones.maintenance.x_start + (processZones.maintenance.width - abelWidth) / 2;
                abel.y_pos = padding;
                abel.cardWidth = abelWidth;
                abel.cardHeight = abelDims.height;
                abel.x_pos = Math.max(padding, Math.min(abel.x_pos, screenWidth - padding - abelWidth));
            }
            
            const topLevelY = padding + (dora ? dora.cardHeight : 80) + (isSmallScreen ? 20 : 30);
            
            // Position employees in process flow zones - ONLY UNDER DORA
            const doraDirectReports = employees.filter(emp => emp.parentId === 1 && !emp.position.includes("Supervisor"));
            
            doraDirectReports.forEach(emp => {
                const dims = cardDimensions[emp.position] || cardDimensions["Manager, Production"];
                emp.cardWidth = dims.photoSize + dims.textWidth + 20;
                emp.cardHeight = dims.height;
                
                switch(emp.department) {
                    case "Extraction":
                        emp.x_pos = processZones.extraction.x_start + (processZones.extraction.width - emp.cardWidth) / 2;
                        emp.y_pos = topLevelY;
                        break;
                    case "Kitchen":
                        emp.x_pos = processZones.kitchen.x_start + (processZones.kitchen.width - emp.cardWidth) / 2;
                        emp.y_pos = topLevelY;
                        break;
                    case "Packaging":
                        emp.x_pos = processZones.packaging.x_start + (processZones.packaging.width - emp.cardWidth) / 2;
                        emp.y_pos = topLevelY;
                        break;
                }
                
                // Ensure cards stay within screen bounds
                emp.x_pos = Math.max(padding, Math.min(emp.x_pos, screenWidth - padding - emp.cardWidth));
            });
            
            // QUALITY SPECIALIST POSITIONING - UNDER EXTRACTION IN VERTICAL FLOW
            const mariela = employees.find(emp => emp.name === "Mariela De La Rosa");
            const daniel = employees.find(emp => emp.name === "Daniel Gelpi");
            
            if (mariela && daniel) {
                const dims = cardDimensions[mariela.position] || cardDimensions["Quality Specialist"];
                mariela.cardWidth = dims.photoSize + dims.textWidth + 20;
                mariela.cardHeight = dims.height;
                
                // Position Mariela under the extraction department card in vertical flow
                mariela.x_pos = processZones.extraction.x_start + (processZones.extraction.width - mariela.cardWidth) / 2;
                mariela.y_pos = topLevelY + daniel.cardHeight + cardDimensions.Department.height + 60; // Under extraction dept card
                mariela.x_pos = Math.max(padding, Math.min(mariela.x_pos, screenWidth - padding - mariela.cardWidth));
            }
            
            // POSITION SUNITA AND CARLOS AT SECOND LEVEL WITH OTHER SUPERVISORS
            const sunita = employees.find(emp => emp.name === "Sunita Jainanan");
            const carlos = employees.find(emp => emp.name === "Carlos Archaga");
            
            const secondLevelY = topLevelY + cardDimensions["Manager, Production"].height + (isSmallScreen ? 20 : 35); // Increased spacing
            
            if (sunita && carlos) {
                const dims = cardDimensions["Supervisor, Processing"];
                sunita.cardWidth = dims.photoSize + dims.textWidth + 20;
                sunita.cardHeight = dims.height;
                carlos.cardWidth = dims.photoSize + dims.textWidth + 20;
                carlos.cardHeight = dims.height;
                
                // Position them side by side in processing zone
                const totalWidth = sunita.cardWidth + carlos.cardWidth + 10;
                let startX = processZones.processing.x_start + (processZones.processing.width - totalWidth) / 2;
                
                sunita.x_pos = Math.max(padding, startX);
                sunita.y_pos = secondLevelY;
                carlos.x_pos = Math.max(padding, sunita.x_pos + sunita.cardWidth + 10);
                carlos.y_pos = secondLevelY;
                
                // Ensure cards stay within screen bounds
                sunita.x_pos = Math.min(sunita.x_pos, screenWidth - padding - sunita.cardWidth);
                carlos.x_pos = Math.min(carlos.x_pos, screenWidth - padding - carlos.cardWidth);
            }

            // IMPROVED SECOND-LEVEL POSITIONING WITH BETTER SPACING
            const secondLevel = employees.filter(emp => 
                (emp.position.includes("Supervisor") || emp.position.includes("Manager") || emp.position.includes("Lead")) && 
                emp.parentId !== null && emp.parentId !== 1 && emp.parentId !== 140 && // Exclude Mariela (parentId 140) and direct Dora reports
                emp.name !== "Sunita Jainanan" && emp.name !== "Carlos Archaga" // Exclude already positioned supervisors
            );
            
            const groupedByParent = {};
            secondLevel.forEach(emp => {
                if (!groupedByParent[emp.parentId]) {
                    groupedByParent[emp.parentId] = [];
                }
                groupedByParent[emp.parentId].push(emp);
            });
            
            Object.keys(groupedByParent).forEach(parentId => {
                const group = groupedByParent[parentId];
                const parent = employees.find(emp => emp.id === parseInt(parentId));
                
                if (parent && parent.x_pos !== undefined) {
                    group.forEach((child, index) => {
                        const dims = cardDimensions[child.position] || cardDimensions["Supervisor, Production"];
                        child.cardWidth = dims.photoSize + dims.textWidth + 20;
                        child.cardHeight = dims.height;
                        
                        // IMPROVED SPACING FOR KITCHEN LEADS - Move them further down
                        if (parent.name === "Luis Hernandez") {
                            const adjustedY = secondLevelY + 150; // Increased spacing
                            if (group.length === 1) {
                                child.x_pos = parent.x_pos + (parent.cardWidth - child.cardWidth) / 2;
                                child.y_pos = adjustedY;
                            } else {
                                const spacing = 10;
                                const totalWidth = group.reduce((sum, c) => {
                                    const cDims = cardDimensions[c.position] || cardDimensions["Lead, Kitchen"];
                                    return sum + cDims.photoSize + cDims.textWidth + 20;
                                }, 0) + (group.length - 1) * spacing;
                                
                                let startX = parent.x_pos + (parent.cardWidth - totalWidth) / 2;
                                let currentX = startX;
                                
                                group.forEach((c, i) => {
                                    c.x_pos = Math.max(padding, currentX);
                                    c.y_pos = adjustedY;
                                    currentX += c.cardWidth + spacing;
                                    c.x_pos = Math.min(c.x_pos, screenWidth - padding - c.cardWidth);
                                });
                            }
                        }
                        // SUSANA (Manager under Michael) - Move further down
                        else if (parent.name === "Michael Amaya") {
                            const adjustedY = secondLevelY + 140; // Increased spacing
                            child.x_pos = parent.x_pos + (parent.cardWidth - child.cardWidth) / 2;
                            child.y_pos = adjustedY;
                            child.x_pos = Math.max(padding, Math.min(child.x_pos, screenWidth - padding - child.cardWidth));
                        }
                        // NORMA (Supervisor under Susana) - Move further down relative to Susana
                        else if (parent.name === "Susana Ceballos") {
                            const susanaEmp = employees.find(e => e.name === "Susana Ceballos");
                            const thirdLevelY = (susanaEmp.y_pos || secondLevelY + 140) + susanaEmp.cardHeight + 35;
                            child.x_pos = parent.x_pos + (parent.cardWidth - child.cardWidth) / 2;
                            child.y_pos = thirdLevelY;
                            child.x_pos = Math.max(padding, Math.min(child.x_pos, screenWidth - padding - child.cardWidth));
                        }
                        // DAN PELUSO (Supervisor under Abel)
                        else if (parent.name === "Abel Ortega") {
                            const adjustedY = secondLevelY + 140; // Increased spacing
                            child.x_pos = parent.x_pos + (parent.cardWidth - child.cardWidth) / 2;
                            child.y_pos = adjustedY;
                            child.x_pos = Math.max(padding, Math.min(child.x_pos, screenWidth - padding - child.cardWidth));
                        }
                        // PACKAGING SUPERVISORS - Move them down more to give Lester space
                        else if (parent.name === "Lester Igarza" && group.length === 3) {
                            const adjustedY = secondLevelY + 50; // Increased spacing from packaging manager
                            const spacing = 10;
                            const totalWidth = group.reduce((sum, c) => {
                                const cDims = cardDimensions[c.position] || cardDimensions["Supervisor, Production"];
                                return sum + cDims.photoSize + cDims.textWidth + 20;
                            }, 0) + (group.length - 1) * spacing;
                            
                            let startX = parent.x_pos + (parent.cardWidth - totalWidth) / 2;
                            let currentX = startX;
                            
                            group.forEach((c, i) => {
                                c.x_pos = Math.max(padding, currentX);
                                c.y_pos = adjustedY;
                                currentX += c.cardWidth + spacing;
                                c.x_pos = Math.min(c.x_pos, screenWidth - padding - c.cardWidth);
                            });
                        }
                        // DEFAULT POSITIONING for other groups
                        else if (group.length === 1) {
                            child.x_pos = parent.x_pos + (parent.cardWidth - child.cardWidth) / 2;
                            child.y_pos = secondLevelY;
                            child.x_pos = Math.max(padding, Math.min(child.x_pos, screenWidth - padding - child.cardWidth));
                        } else {
                            const spacing = 10;
                            const totalWidth = group.reduce((sum, c) => {
                                const cDims = cardDimensions[c.position] || cardDimensions["Supervisor, Production"];
                                return sum + cDims.photoSize + cDims.textWidth + 20;
                            }, 0) + (group.length - 1) * spacing;
                            
                            let startX = parent.x_pos + (parent.cardWidth - totalWidth) / 2;
                            let currentX = startX;
                            
                            group.forEach((c, i) => {
                                c.x_pos = Math.max(padding, currentX);
                                c.y_pos = secondLevelY;
                                currentX += c.cardWidth + spacing;
                                c.x_pos = Math.min(c.x_pos, screenWidth - padding - c.cardWidth);
                            });
                        }
                    });
                }
            });
            
            // DEPARTMENT CARD POSITIONING WITH VERTICAL EXTRACTION/QUALITY FLOW
            const baseGap = isSmallScreen ? 15 : 20;
            const deptY = Math.max(secondLevelY + cardDimensions["Supervisor, Production"].height + baseGap - 40, screenHeight - cardDimensions["Department"].height - 25);
            window.departmentSummaries = [];
            
            departmentNames.forEach((deptName) => {
                const deptEmployees = employees.filter(emp => emp.department === deptName && (emp.position === "Employee" || emp.position === "Associate"));
                
                if (deptEmployees.length > 0) {
                    let avgX;
                    let positionY = deptY;
                    
                    switch(deptName) {
                        case "Extraction":
                            avgX = processZones.extraction.x_start + processZones.extraction.width / 2;
                            // Extraction department card positioned under Daniel Gelpi
                            positionY = topLevelY + cardDimensions["Manager, Extraction"].height + 25;
                            break;
                        case "Processing Lab":
                            avgX = processZones.processing.x_start + processZones.processing.width / 2;
                            break;
                        case "Kitchen":
                            avgX = processZones.kitchen.x_start + processZones.kitchen.width / 2;
                            break;
                        case "Packaging":
                            avgX = processZones.packaging.x_start + processZones.packaging.width / 2;
                            break;
                        case "Warehouse":
                            avgX = processZones.warehouse.x_start + processZones.warehouse.width / 2;
                            break;
                        case "Maintenance":
                            avgX = processZones.maintenance.x_start + processZones.maintenance.width / 2;
                            break;
                        case "Quality":
                            // Quality department card positioned under Mariela in extraction zone
                            avgX = processZones.extraction.x_start + processZones.extraction.width / 2;
                            positionY = mariela ? mariela.y_pos + mariela.cardHeight + 25 : deptY + cardDimensions.Department.height + 20;
                            break;
                        default:
                            avgX = (screenWidth) / 2;
                    }
                    
                    const deptSummary = {
                        name: deptName,
                        employee_count: deptEmployees.length,
                        x_pos: avgX - cardDimensions.Department.width / 2,
                        y_pos: positionY,
                        width: cardDimensions.Department.width,
                        height: cardDimensions.Department.height,
                        color: deptEmployees[0].dept_color
                    };
                    
                    deptSummary.x_pos = Math.max(padding, Math.min(deptSummary.x_pos, screenWidth - padding - cardDimensions.Department.width));
                    
                    window.departmentSummaries.push(deptSummary);
                }
            });
            
            window.currentCardDimensions = cardDimensions;
        }
        
        // IMPROVED CARD CREATION WITH BETTER TEXT DISPLAY AND POSITION WRAPPING
        function createEmployeeCard(employee, cardDimensions) {
            const card = document.createElement("div");
            
            const dimensions = cardDimensions[employee.position] || cardDimensions["Manager, Production"];
            const cardWidth = employee.cardWidth || (dimensions.photoSize + dimensions.textWidth + 20);
            const cardHeight = employee.cardHeight || dimensions.height;
            
            // Use department-based class instead of position-based
            const deptClass = `dept-${employee.department.toLowerCase().replace(/\s+/g, '-')}-card`;
            const positionClass = `${employee.position.toLowerCase().replace(/\s+/g, '-').replace(/,/g, '')}-card`;
            
            card.className = `employee-card ${deptClass} ${positionClass}`;
            card.style.left = employee.x_pos + "px";
            card.style.top = employee.y_pos + "px";
            card.style.width = cardWidth + "px";
            card.style.height = cardHeight + "px";
            
            // PHOTO SECTION - Auto size
            const photoSection = document.createElement("div");
            photoSection.className = "card-photo-section";
            
            const textSection = document.createElement("div");
            textSection.className = "card-text-section";
            
            // PHOTO
            const photoSize = dimensions.photoSize;
            
            const photo = document.createElement("img");
            photo.className = "card-photo";
            
            // Use actual photo if available, otherwise fall back to generated avatar
            if (employee.photo) {
                photo.src = employee.photo;
                photo.onerror = function() {
                    // Fallback to generated avatar if photo fails to load
                    this.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='${photoSize}' height='${photoSize}' viewBox='0 0 ${photoSize} ${photoSize}'><rect width='${photoSize}' height='${photoSize}' fill='%23ecf0f1' rx='3' ry='3'/><circle cx='${photoSize/2}' cy='${photoSize*0.35}' r='${photoSize*0.12}' fill='%23bdc3c7'/><ellipse cx='${photoSize/2}' cy='${photoSize*0.78}' rx='${photoSize*0.18}' ry='${photoSize*0.12}' fill='%23bdc3c7'/></svg>`;
                };
            } else {
                photo.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='${photoSize}' height='${photoSize}' viewBox='0 0 ${photoSize} ${photoSize}'><rect width='${photoSize}' height='${photoSize}' fill='%23ecf0f1' rx='3' ry='3'/><circle cx='${photoSize/2}' cy='${photoSize*0.35}' r='${photoSize*0.12}' fill='%23bdc3c7'/><ellipse cx='${photoSize/2}' cy='${photoSize*0.78}' rx='${photoSize*0.18}' ry='${photoSize*0.12}' fill='%23bdc3c7'/></svg>`;
            }
            
            photo.alt = employee.name;
            photo.style.width = photoSize + "px";
            photo.style.height = photoSize + "px";
            
            photoSection.appendChild(photo);
            
            // TEXT CONTENT - IMPROVED VISIBILITY WITH POSITION WRAPPING
            const wrappedName = wrapLongName(employee.name);
            const wrappedPosition = wrapLongPosition(employee.position);
            
            // Employee Name (PRIMARY)
            const nameDiv = document.createElement("div");
            nameDiv.className = "card-name";
            nameDiv.innerHTML = wrappedName;
            textSection.appendChild(nameDiv);
            
            // Job Title (SECONDARY - right under name)
            const titleDiv = document.createElement("div");
            titleDiv.className = "card-title";
            titleDiv.textContent = employee.position;
            textSection.appendChild(titleDiv);
            
            // Position (TERTIARY - underneath title) - NOW WITH WRAPPING
            const positionDiv = document.createElement("div");
            positionDiv.className = "card-position";
            positionDiv.innerHTML = wrappedPosition;
            textSection.appendChild(positionDiv);
            
            card.appendChild(photoSection);
            card.appendChild(textSection);
            
            return card;
        }
        
        function createDepartmentCard(deptData, cardDimensions) {
            const card = document.createElement("div");
            const dimensions = cardDimensions["Department"];
            
            card.className = `department-card dept-${deptData.name.toLowerCase().replace(/\s+/g, "-")}`;
            card.style.left = deptData.x_pos + "px";
            card.style.top = deptData.y_pos + "px";
            card.style.width = dimensions.width + "px";
            card.style.height = dimensions.height + "px";
            
            const isSmallScreen = screenWidth < 1400;
            const titleSize = Math.max(isSmallScreen ? 8 : 10, Math.min(isSmallScreen ? 10 : 13, dimensions.width / 12));
            const countSize = Math.max(isSmallScreen ? 7 : 9, Math.min(isSmallScreen ? 9 : 11, dimensions.width / 14));
            
            card.innerHTML = `
                <div class="dept-title" style="font-size: ${titleSize}px;">${deptData.name}</div>
                <div class="dept-count" style="font-size: ${countSize}px;">(${deptData.employee_count}) employees</div>
            `;
            
            card.addEventListener("click", () => openDrillDown(deptData.name));
            
            return card;
        }
        
        // UPDATED CONNECTION SYSTEM FOR THREE CO-EQUAL LEADERS
        function generateConnectionLines(cardDimensions) {
            const chartContainer = document.getElementById("orgChart");
            if (!chartContainer) return;
            
            createdConnections.clear();
            
            // DORA'S DIRECT REPORTS - UPDATED TO EXCLUDE MICHAEL AND ABEL
            const dora = employees.find(emp => emp.name === "Dora Gaeza");
            const doraDirectReportNames = [
                "Daniel Gelpi", "Luis Hernandez", "Lester Igarza", 
                "Sunita Jainanan", "Carlos Archaga"
            ];
            
            doraDirectReportNames.forEach(name => {
                const employee = employees.find(emp => emp.name === name);
                if (employee && employee.x_pos !== undefined && dora.x_pos !== undefined) {
                    const connectionKey = `${dora.id}->${employee.id}`;
                    if (!createdConnections.has(connectionKey)) {
                        const connectionElements = createDoraConnection(dora, employee, cardDimensions);
                        connectionElements.forEach(element => chartContainer.appendChild(element));
                        createdConnections.add(connectionKey);
                    }
                }
            });
            
            // MICHAEL'S DIRECT REPORTS
            const michael = employees.find(emp => emp.name === "Michael Amaya");
            const michaelDirectReportNames = ["Susana Ceballos"];
            
            michaelDirectReportNames.forEach(name => {
                const employee = employees.find(emp => emp.name === name);
                if (employee && employee.x_pos !== undefined && michael.x_pos !== undefined) {
                    const connectionKey = `${michael.id}->${employee.id}`;
                    if (!createdConnections.has(connectionKey)) {
                        const connectionElements = createMichaelConnection(michael, employee, cardDimensions);
                        connectionElements.forEach(element => chartContainer.appendChild(element));
                        createdConnections.add(connectionKey);
                    }
                }
            });
            
            // ABEL'S DIRECT REPORTS
            const abel = employees.find(emp => emp.name === "Abel Ortega");
            const abelDirectReportNames = ["Dan Peluso"];
            
            abelDirectReportNames.forEach(name => {
                const employee = employees.find(emp => emp.name === name);
                if (employee && employee.x_pos !== undefined && abel.x_pos !== undefined) {
                    const connectionKey = `${abel.id}->${employee.id}`;
                    if (!createdConnections.has(connectionKey)) {
                        const connectionElements = createAbelConnection(abel, employee, cardDimensions);
                        connectionElements.forEach(element => chartContainer.appendChild(element));
                        createdConnections.add(connectionKey);
                    }
                }
            });
            
            // CONNECTION FROM DANIEL TO MARIELA (EXTRACTION TO QUALITY)
            const daniel = employees.find(emp => emp.name === "Daniel Gelpi");
            const mariela = employees.find(emp => emp.name === "Mariela De La Rosa");
            if (daniel && mariela && daniel.x_pos !== undefined && mariela.x_pos !== undefined) {
                const connectionKey = `${daniel.id}->${mariela.id}`;
                if (!createdConnections.has(connectionKey)) {
                    const connectionElements = createIndividualConnection(daniel, mariela, cardDimensions, "department");
                    connectionElements.forEach(element => chartContainer.appendChild(element));
                    createdConnections.add(connectionKey);
                }
            }
            
            // MANAGER/DIRECTOR CONNECTIONS - WITH DEPARTMENT COLORS FOR SAME-DEPT CONNECTIONS
            const managerConnections = [
                { manager: "Lester Igarza", reports: ["Jubilee Rodriguez", "Maria Mendez", "Samantha Perez-Morell"] },
                { manager: "Luis Hernandez", reports: ["Idalmis Medina Rodriguez", "Nathan Vargas"] },
                { manager: "Susana Ceballos", reports: ["Norma Rodriguez"] }
            ];
            
            managerConnections.forEach(({ manager, reports }) => {
                const managerEmp = employees.find(emp => emp.name === manager);
                reports.forEach(reportName => {
                    const reportEmp = employees.find(emp => emp.name === reportName);
                    if (managerEmp && reportEmp && managerEmp.x_pos !== undefined && reportEmp.x_pos !== undefined) {
                        const connectionKey = `${managerEmp.id}->${reportEmp.id}`;
                        if (!createdConnections.has(connectionKey)) {
                            let lineType = "regular";
                            if (managerEmp.department === reportEmp.department) {
                                lineType = "department"; // Use department color for same-department connections
                            }
                            const connectionElements = createIndividualConnection(managerEmp, reportEmp, cardDimensions, lineType);
                            connectionElements.forEach(element => chartContainer.appendChild(element));
                            createdConnections.add(connectionKey);
                        }
                    }
                });
            });
            
            // Create lines to department cards
            const leadershipRoles = employees.filter(emp => 
                (emp.position.includes("Supervisor") || emp.position.includes("Manager") || emp.position === "Quality Specialist") && 
                emp.x_pos !== undefined
            );
            
            leadershipRoles.forEach(leader => {
                if (window.departmentSummaries) {
                    const deptCard = window.departmentSummaries.find(dept => dept.name === leader.department);
                    if (deptCard) {
                        const lines = createOptimizedSupervisorToDeptLines(leader, deptCard, cardDimensions);
                        lines.forEach(line => chartContainer.appendChild(line));
                    }
                }
            });
        }
        
        // NEW FUNCTION FOR DORA'S HORIZONTAL-FIRST CONNECTIONS
        function createDoraConnection(dora, target, cardDimensions) {
            const elements = [];
            
            if (dora.x_pos === undefined || target.x_pos === undefined) {
                return elements;
            }
            
            const doraX = dora.x_pos + (dora.cardWidth || 100) / 2;
            const doraY = dora.y_pos + (dora.cardHeight || 60);
            const targetX = target.x_pos + (target.cardWidth || 100) / 2;
            const targetY = target.y_pos;
            
            const isSmallScreen = screenWidth < 1400;
            const lineWidth = Math.max(isSmallScreen ? 2 : 3, Math.min(isSmallScreen ? 3 : 4, Math.round(screenWidth / 400)));
            const lineClass = "hierarchy-line-plant-manager";
            
            // HORIZONTAL FIRST, THEN VERTICAL ROUTING
            const horizontalY = doraY + 20; // Distance down from Dora before going horizontal
            
            // Step 1: Vertical line down from Dora
            const verticalLine1 = document.createElement("div");
            verticalLine1.className = lineClass;
            verticalLine1.style.left = (doraX - lineWidth/2) + "px";
            verticalLine1.style.top = doraY + "px";
            verticalLine1.style.width = lineWidth + "px";
            verticalLine1.style.height = 20 + "px"; // Fixed distance down
            elements.push(verticalLine1);
            
            // Step 2: Horizontal line to target's X position
            const horizontalLine = document.createElement("div");
            horizontalLine.className = lineClass;
            const horizontalStart = Math.min(doraX, targetX);
            const horizontalEnd = Math.max(doraX, targetX);
            horizontalLine.style.left = (horizontalStart - lineWidth/2) + "px";
            horizontalLine.style.top = (horizontalY - lineWidth/2) + "px";
            horizontalLine.style.width = (horizontalEnd - horizontalStart + lineWidth) + "px";
            horizontalLine.style.height = lineWidth + "px";
            elements.push(horizontalLine);
            
            // Step 3: Vertical line down to target
            const verticalLine2 = document.createElement("div");
            verticalLine2.className = lineClass;
            verticalLine2.style.left = (targetX - lineWidth/2) + "px";
            verticalLine2.style.top = horizontalY + "px";
            verticalLine2.style.width = lineWidth + "px";
            verticalLine2.style.height = (targetY - horizontalY) + "px";
            elements.push(verticalLine2);
            
            return elements;
        }
        
        // NEW FUNCTION FOR MICHAEL'S CONNECTIONS
        function createMichaelConnection(michael, target, cardDimensions) {
            const elements = [];
            
            if (michael.x_pos === undefined || target.x_pos === undefined) {
                return elements;
            }
            
            const michaelX = michael.x_pos + (michael.cardWidth || 100) / 2;
            const michaelY = michael.y_pos + (michael.cardHeight || 60);
            const targetX = target.x_pos + (target.cardWidth || 100) / 2;
            const targetY = target.y_pos;
            
            const isSmallScreen = screenWidth < 1400;
            const lineWidth = Math.max(isSmallScreen ? 2 : 3, Math.min(isSmallScreen ? 3 : 4, Math.round(screenWidth / 400)));
            const lineClass = "hierarchy-line-director";
            
            // Direct vertical connection for Michael to Susana
            const verticalLine = document.createElement("div");
            verticalLine.className = lineClass;
            verticalLine.style.left = (michaelX - lineWidth/2) + "px";
            verticalLine.style.top = michaelY + "px";
            verticalLine.style.width = lineWidth + "px";
            verticalLine.style.height = (targetY - michaelY) + "px";
            elements.push(verticalLine);
            
            return elements;
        }
        
        // NEW FUNCTION FOR ABEL'S CONNECTIONS
        function createAbelConnection(abel, target, cardDimensions) {
            const elements = [];
            
            if (abel.x_pos === undefined || target.x_pos === undefined) {
                return elements;
            }
            
            const abelX = abel.x_pos + (abel.cardWidth || 100) / 2;
            const abelY = abel.y_pos + (abel.cardHeight || 60);
            const targetX = target.x_pos + (target.cardWidth || 100) / 2;
            const targetY = target.y_pos;
            
            const isSmallScreen = screenWidth < 1400;
            const lineWidth = Math.max(isSmallScreen ? 2 : 3, Math.min(isSmallScreen ? 3 : 4, Math.round(screenWidth / 400)));
            const lineClass = "hierarchy-line-maintenance";
            
            // Direct vertical connection for Abel to Dan
            const verticalLine = document.createElement("div");
            verticalLine.className = lineClass;
            verticalLine.style.left = (abelX - lineWidth/2) + "px";
            verticalLine.style.top = abelY + "px";
            verticalLine.style.width = lineWidth + "px";
            verticalLine.style.height = (targetY - abelY) + "px";
            elements.push(verticalLine);
            
            return elements;
        }
        
        function createIndividualConnection(parent, child, cardDimensions, lineType) {
            const elements = [];
            
            if (parent.x_pos === undefined || child.x_pos === undefined) {
                return elements;
            }
            
            const parentX = parent.x_pos + (parent.cardWidth || 100) / 2;
            const parentY = parent.y_pos + (parent.cardHeight || 60);
            const childX = child.x_pos + (child.cardWidth || 100) / 2;
            const childY = child.y_pos;
            
            const isSmallScreen = screenWidth < 1400;
            let lineWidth;
            let lineClass;
            let customBackground = null;
            
            if (lineType === "plant-manager") {
                lineWidth = Math.max(isSmallScreen ? 2 : 3, Math.min(isSmallScreen ? 3 : 4, Math.round(screenWidth / 400)));
                lineClass = "hierarchy-line-plant-manager";
            } else if (lineType === "director") {
                lineWidth = Math.max(isSmallScreen ? 1 : 2, Math.min(isSmallScreen ? 2 : 3, Math.round(screenWidth / 500)));
                lineClass = "hierarchy-line-director";
            } else if (lineType === "department") {
                lineWidth = Math.max(isSmallScreen ? 1 : 2, Math.min(isSmallScreen ? 2 : 3, Math.round(screenWidth / 600)));
                lineClass = "connection-line";
                customBackground = `linear-gradient(180deg, ${parent.dept_color}CC, ${parent.dept_color}80)`;
            } else {
                lineWidth = Math.max(isSmallScreen ? 1 : 2, Math.min(isSmallScreen ? 2 : 3, Math.round(screenWidth / 600)));
                lineClass = "connection-line";
            }
            
            if (Math.abs(parentX - childX) <= 15) {
                const verticalLine = document.createElement("div");
                verticalLine.className = lineClass;
                if (customBackground) {
                    verticalLine.style.background = customBackground;
                }
                verticalLine.style.left = (parentX - lineWidth/2) + "px";
                verticalLine.style.top = parentY + "px";
                verticalLine.style.width = lineWidth + "px";
                verticalLine.style.height = (childY - parentY) + "px";
                elements.push(verticalLine);
            } else {
                const midY = parentY + (childY - parentY) * 0.5;
                
                const verticalLine1 = document.createElement("div");
                verticalLine1.className = lineClass;
                if (customBackground) {
                    verticalLine1.style.background = customBackground;
                }
                verticalLine1.style.left = (parentX - lineWidth/2) + "px";
                verticalLine1.style.top = parentY + "px";
                verticalLine1.style.width = lineWidth + "px";
                verticalLine1.style.height = (midY - parentY) + "px";
                elements.push(verticalLine1);
                
                const horizontalLine = document.createElement("div");
                horizontalLine.className = lineClass;
                if (customBackground) {
                    horizontalLine.style.background = `linear-gradient(90deg, ${parent.dept_color}80, ${parent.dept_color}80)`;
                }
                const horizontalStart = Math.min(parentX, childX);
                const horizontalEnd = Math.max(parentX, childX);
                horizontalLine.style.left = (horizontalStart - lineWidth/2) + "px";
                horizontalLine.style.top = (midY - lineWidth/2) + "px";
                horizontalLine.style.width = (horizontalEnd - horizontalStart + lineWidth) + "px";
                horizontalLine.style.height = lineWidth + "px";
                elements.push(horizontalLine);
                
                const verticalLine2 = document.createElement("div");
                verticalLine2.className = lineClass;
                if (customBackground) {
                    verticalLine2.style.background = customBackground;
                }
                verticalLine2.style.left = (childX - lineWidth/2) + "px";
                verticalLine2.style.top = midY + "px";
                verticalLine2.style.width = lineWidth + "px";
                verticalLine2.style.height = (childY - midY) + "px";
                elements.push(verticalLine2);
            }
            
            return elements;
        }
        
        function createOptimizedSupervisorToDeptLines(supervisor, deptCard, cardDimensions) {
            const lines = [];
            
            const supervisorX = supervisor.x_pos + (supervisor.cardWidth || 100) / 2;
            const supervisorY = supervisor.y_pos + (supervisor.cardHeight || 60);
            const deptX = deptCard.x_pos + deptCard.width / 2;
            const deptY = deptCard.y_pos;
            
            const isSmallScreen = screenWidth < 1400;
            const lineWidth = Math.max(isSmallScreen ? 1 : 2, Math.min(isSmallScreen ? 2 : 3, Math.round(screenWidth / 600)));
            
            if (Math.abs(supervisorX - deptX) <= 25) {
                const verticalLine = document.createElement("div");
                verticalLine.className = "connection-line";
                verticalLine.style.background = `linear-gradient(180deg, ${supervisor.dept_color}CC, ${supervisor.dept_color}80)`;
                verticalLine.style.left = (supervisorX - lineWidth/2) + "px";
                verticalLine.style.top = supervisorY + "px";
                verticalLine.style.width = lineWidth + "px";
                verticalLine.style.height = (deptY - supervisorY) + "px";
                lines.push(verticalLine);
            } else {
                const midY = supervisorY + (deptY - supervisorY) * 0.6;
                
                const verticalLine1 = document.createElement("div");
                verticalLine1.className = "connection-line";
                verticalLine1.style.background = `linear-gradient(180deg, ${supervisor.dept_color}CC, ${supervisor.dept_color}80)`;
                verticalLine1.style.left = (supervisorX - lineWidth/2) + "px";
                verticalLine1.style.top = supervisorY + "px";
                verticalLine1.style.width = lineWidth + "px";
                verticalLine1.style.height = (midY - supervisorY) + "px";
                lines.push(verticalLine1);
                
                const horizontalLine = document.createElement("div");
                horizontalLine.className = "connection-line";
                horizontalLine.style.background = `linear-gradient(90deg, ${supervisor.dept_color}80, ${supervisor.dept_color}80)`;
                const horizontalStart = Math.min(supervisorX, deptX);
                const horizontalEnd = Math.max(supervisorX, deptX);
                horizontalLine.style.left = (horizontalStart - lineWidth/2) + "px";
                horizontalLine.style.top = (midY - lineWidth/2) + "px";
                horizontalLine.style.width = (horizontalEnd - horizontalStart + lineWidth) + "px";
                horizontalLine.style.height = lineWidth + "px";
                lines.push(horizontalLine);
                
                const verticalLine2 = document.createElement("div");
                verticalLine2.className = "connection-line";
                verticalLine2.style.background = `linear-gradient(180deg, ${supervisor.dept_color}80, ${supervisor.dept_color}CC)`;
                verticalLine2.style.left = (deptX - lineWidth/2) + "px";
                verticalLine2.style.top = midY + "px";
                verticalLine2.style.width = lineWidth + "px";
                verticalLine2.style.height = (deptY - midY) + "px";
                lines.push(verticalLine2);
            }
            
            return lines;
        }
        
        function initHierarchyView() {
            calculateProcessFlowLayout();
            
            const chartContainer = document.getElementById("orgChart");
            chartContainer.innerHTML = "";
            
            const cardDimensions = window.currentCardDimensions;
            
            generateConnectionLines(cardDimensions);
            
            employees.forEach(emp => {
                if (emp.position !== "Employee" && emp.position !== "Associate" && emp.x_pos !== undefined) {
                    const card = createEmployeeCard(emp, cardDimensions);
                    chartContainer.appendChild(card);
                }
            });
            
            if (window.departmentSummaries) {
                window.departmentSummaries.forEach(deptData => {
                    const card = createDepartmentCard(deptData, cardDimensions);
                    chartContainer.appendChild(card);
                });
            }
        }
        
        function openDrillDown(departmentName) {
            currentDepartment = departmentName;
            isDrillDownActive = true;
            
            const hierarchyView = document.getElementById("hierarchyView");
            const drillDownView = document.getElementById("drillDownView");
            const drillDownTitle = document.getElementById("drillDownTitle");
            const drillDownContent = document.getElementById("drillDownContent");
            
            hierarchyView.classList.add("hidden");
            drillDownView.classList.add("active");
            
            const deptEmployees = employees.filter(emp => emp.department === departmentName && (emp.position === "Employee" || emp.position === "Associate"));
            const deptLeadership = employees.filter(emp => emp.department === departmentName && emp.position !== "Employee" && emp.position !== "Associate");
            const allDeptMembers = [...deptLeadership, ...deptEmployees];
            
            drillDownTitle.textContent = `${departmentName} Department (${deptEmployees.length} Employees${deptLeadership.length > 0 ? ` + ${deptLeadership.length} Leadership` : ''})`;
            
            layoutDrillDownEmployees(allDeptMembers, drillDownContent);
        }
        
        function layoutDrillDownEmployees(deptMembers, container) {
            container.innerHTML = "";
            
            const availableWidth = screenWidth - 40;
            const availableHeight = screenHeight - 100;
            const numMembers = deptMembers.length;
            
            let bestCols = 1;
            let bestCardSize = 0;
            
            for (let cols = 1; cols <= Math.min(20, numMembers); cols++) {
                const rows = Math.ceil(numMembers / cols);
                const cardWidth = Math.floor((availableWidth - (cols - 1) * 8) / cols);
                const cardHeight = Math.floor((availableHeight - (rows - 1) * 10) / rows);
                const cardSize = Math.min(cardWidth, cardHeight);
                
                if (cardSize > bestCardSize && cardSize >= 60) {
                    bestCardSize = cardSize;
                    bestCols = cols;
                }
            }
            
            bestCardSize = Math.min(bestCardSize, 140);
            
            deptMembers.forEach((member, index) => {
                const row = Math.floor(index / bestCols);
                const col = index % bestCols;
                
                const card = document.createElement("div");
                card.className = "drill-employee-card";
                card.style.width = bestCardSize + "px";
                card.style.height = (bestCardSize * 0.6) + "px";
                card.style.left = (col * (bestCardSize + 8) + 20) + "px";
                card.style.top = (row * (bestCardSize * 0.6 + 10) + 20) + "px";
                card.style.position = "absolute";
                
                if (member.position.includes("Manager") || member.position.includes("Supervisor") || member.position.includes("Lead") || member.position === "Quality Specialist") {
                    card.style.border = `3px solid ${member.dept_color}`;
                    card.style.background = "linear-gradient(145deg, #fff3cd, #ffeaa7)";
                    card.style.boxShadow = `0 6px 20px ${member.dept_color}40`;
                }
                
                const photoSection = document.createElement("div");
                photoSection.className = "drill-card-photo-section";
                
                const textSection = document.createElement("div");
                textSection.className = "drill-card-text-section";
                
                const photoSize = Math.min(bestCardSize * 0.25, 35);
                
                const photo = document.createElement("img");
                photo.className = "card-photo";
                
                // Use actual photo if available, otherwise fall back to generated avatar
                if (member.photo) {
                    photo.src = member.photo;
                    photo.onerror = function() {
                        this.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='${photoSize}' height='${photoSize}' viewBox='0 0 ${photoSize} ${photoSize}'><rect width='${photoSize}' height='${photoSize}' fill='%23ecf0f1' rx='2' ry='2'/><circle cx='${photoSize/2}' cy='${photoSize*0.35}' r='${photoSize*0.11}' fill='%23bdc3c7'/><ellipse cx='${photoSize/2}' cy='${photoSize*0.75}' rx='${photoSize*0.16}' ry='${photoSize*0.10}' fill='%23bdc3c7'/></svg>`;
                    };
                } else {
                    photo.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='${photoSize}' height='${photoSize}' viewBox='0 0 ${photoSize} ${photoSize}'><rect width='${photoSize}' height='${photoSize}' fill='%23ecf0f1' rx='2' ry='2'/><circle cx='${photoSize/2}' cy='${photoSize*0.35}' r='${photoSize*0.11}' fill='%23bdc3c7'/><ellipse cx='${photoSize/2}' cy='${photoSize*0.75}' rx='${photoSize*0.16}' ry='${photoSize*0.10}' fill='%23bdc3c7'/></svg>`;
                }
                
                photo.alt = member.name;
                photo.style.width = photoSize + "px";
                photo.style.height = photoSize + "px";
                
                photoSection.appendChild(photo);
                
                const wrappedName = wrapLongName(member.name);
                
                const nameDiv = document.createElement("div");
                nameDiv.className = "drill-card-name";
                nameDiv.innerHTML = wrappedName;
                textSection.appendChild(nameDiv);
                
                // Add job title for all members
                const titleDiv = document.createElement("div");
                titleDiv.className = "drill-card-title";
                titleDiv.textContent = member.position;
                textSection.appendChild(titleDiv);
                
                if (member.position.includes("Manager") || member.position.includes("Supervisor") || member.position.includes("Lead") || member.position === "Quality Specialist") {
                    const positionDiv = document.createElement("div");
                    positionDiv.className = "drill-card-position";
                    positionDiv.textContent = member.position;
                    positionDiv.style.color = member.dept_color;
                    positionDiv.style.fontWeight = "bold";
                    textSection.appendChild(positionDiv);
                }
                
                card.appendChild(photoSection);
                card.appendChild(textSection);
                
                container.appendChild(card);
            });
        }
        
        function closeDrillDown() {
            const hierarchyView = document.getElementById("hierarchyView");
            const drillDownView = document.getElementById("drillDownView");
            
            if (hierarchyView && drillDownView) {
                hierarchyView.classList.remove("hidden");
                drillDownView.classList.remove("active");
            }
            
            isDrillDownActive = false;
            currentDepartment = null;
        }
        
        // Navigation controls - Updated for new order
        document.addEventListener("keydown", function(e) {
            switch(e.key) {
                case "Escape":
                    e.preventDefault();
                    if (isDrillDownActive) {
                        closeDrillDown();
                    }
                    break;
                    
                case "1": if (!isDrillDownActive) openDrillDown("Extraction"); break;
                case "2": if (!isDrillDownActive) openDrillDown("Processing Lab"); break;
                case "3": if (!isDrillDownActive) openDrillDown("Kitchen"); break;
                case "4": if (!isDrillDownActive) openDrillDown("Packaging"); break;
                case "5": if (!isDrillDownActive) openDrillDown("Warehouse"); break;
                case "6": if (!isDrillDownActive) openDrillDown("Maintenance"); break;
                case "7": if (!isDrillDownActive) openDrillDown("Quality"); break;
            }
        });
        
        window.addEventListener("resize", function() {
            setTimeout(() => {
                if (!isDrillDownActive) {
                    initHierarchyView();
                }
            }, 200);
        });
        
        // Initialize
        document.addEventListener("DOMContentLoaded", function() {
            const backButton = document.getElementById("backButton");
            if (backButton) {
                backButton.addEventListener("click", closeDrillDown);
            }
            
            initHierarchyView();
        });
    </script>
</body>
</html>